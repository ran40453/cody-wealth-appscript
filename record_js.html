<!-- record_js.html -->
<script>
(function(){
  window.App = window.App || {};
  App.state  = App.state || {};

  // —— 數字與膠囊 ——
  function fmtNumTW(n, opt={minimumFractionDigits:1, maximumFractionDigits:1}){
    return Number(n||0).toLocaleString('zh-Hant-TW', opt);
  }
  function pnlBadgeHTML(v){
    const n = Number(v||0);
    const cls = n>0 ? 'pnl-pill pos' : n<0 ? 'pnl-pill neg' : 'pnl-pill zero';
    const sign = n>0 ? '+' : '';
    return `<span class="${cls}">${sign}${fmtNumTW(n)}</span>`;
  }

  // —— 虛擬表 ——
  function createVirtualTable({viewportId, spacerId, theadId, tbodyId, fetcher, pageSize=100}){
    const state = {
      rowHeight: 40,
      pageSize,
      pageCache: new Map(),
      total: 0,
      headers: [],
      viewport: document.getElementById(viewportId),
      spacer:   document.getElementById(spacerId),
      thead:    document.getElementById(theadId),
      tbody:    document.getElementById(tbodyId),
      viewportH: 0,
      lastRange: [-1,-1],
      fetching: new Set()
    };
    function onResize(){ state.viewportH = state.viewport.clientHeight; render(); }
    let tick = null;
    function onScroll(){ if (tick) return; tick = requestAnimationFrame(()=>{ render(); tick=null; }); }

    function render(){
      const top = state.viewport.scrollTop;
      const start = Math.max(0, Math.floor(top / state.rowHeight) - 20);
      const need  = Math.ceil(state.viewportH / state.rowHeight) + 40;
      const end   = Math.min(state.total, start + need);

      const p1 = Math.floor(start / state.pageSize);
      const p2 = Math.floor(Math.max(0, end-1) / state.pageSize);
      for (let p=p1; p<=p2; p++){
        if (!state.pageCache.has(p)) fetchPage(p);
      }
      if (state.lastRange[0]===start && state.lastRange[1]===end) return;
      state.lastRange=[start,end];

      const rows=[];
      for (let i=start;i<end;i++){
        const p = Math.floor(i / state.pageSize);
        const j = i % state.pageSize;
        const page = state.pageCache.get(p);
        rows.push(page && page[j] ? page[j] : null);
      }

      state.tbody.style.transform = `translateY(${start*state.rowHeight}px)`;
      state.tbody.innerHTML = rows.map((r, idx)=>{
        const isLatest = (start + idx === 0); // 第一筆 = 最新
        const trCls = isLatest ? 'is-latest' : '';
        if (!r) return `<tr class="${trCls}" style="height:${state.rowHeight}px"><td colspan="${state.headers.length||1}">載入中…</td></tr>`;
        return `<tr class="${trCls}" style="height:${state.rowHeight}px">${r.map(c=>`<td>${String(c)}</td>`).join('')}</tr>`;
      }).join('');
    }

    function fetchPage(pageIndex){
      if (state.fetching.has(pageIndex)) return;
      state.fetching.add(pageIndex);
      const offset = pageIndex * state.pageSize;
      fetcher({offset, limit: state.pageSize}, (res)=>{
        state.fetching.delete(pageIndex);
        if (!res){ console.warn('[record] 空頁回傳'); return; }
        if (Array.isArray(res.headers) && res.headers.length){
          state.headers = res.headers;
          state.thead.innerHTML = `<tr>${state.headers.map(h=>`<th>${h||''}</th>`).join('')}</tr>`;
        }
        if (typeof res.total==='number'){
          state.total = res.total;
          state.spacer.style.height = (state.total * state.rowHeight) + 'px';
        }
        state.pageCache.set(pageIndex, res.rows || []);
        render();
        const meta = document.getElementById('dbMeta');
        if (meta) meta.textContent = `總筆數：${(state.total||0).toLocaleString('zh-Hant-TW')}　每頁載入：${state.pageSize}　欄位數：${state.headers.length}`;
      });
    }

    state.viewport.addEventListener('scroll', onScroll);
    window.addEventListener('resize', onResize);
    onResize();
    fetchPage(0);

    // 對外 refresh
    state.refresh = function(){
      state.pageCache.clear();
      state.total = 0;
      state.headers = [];
      state.spacer.style.height = '0px';
      state.tbody.innerHTML = '';
      state.thead.innerHTML = '';
      state.viewport.scrollTop = 0;
      state.lastRange = [-1,-1];
      fetchPage(0);
    };
    return state;
  }

  // —— 最新摘要卡 ——（同步 dash KPI 用於保險起見）
  function loadRecordLatest(){
    const box = document.getElementById('dbLatestBox');
    if (box) box.innerHTML = `<div class="empty">載入中…</div>`;
    google.script.run
      .withSuccessHandler(res=>{
        if (!res){ box.innerHTML = `<div class="empty">沒有資料</div>`; return; }
        const rows = [
          ['日期', res.date || '-'],
          ['總資產', fmtNumTW(res.C)],
          ['加上爸爸', fmtNumTW(res.D)],
          ['可動用', fmtNumTW(res.E)],
          ['當日損益', pnlBadgeHTML(res.F)],
          ['現金', fmtNumTW(res.G)],
          ['債務', fmtNumTW(res.BB)],
          ['持有 USD', fmtNumTW(res.CV)]
        ];
        box.innerHTML = rows.map(([k,v])=>`<div class="kv"><div class="k">${k}</div><div class="v">${v}</div></div>`).join('');
        syncKpiFromLatest(res); // 若 dash KPI 容器存在就同步
      })
      .withFailureHandler(err=>{
        console.error('[record] getRecordLatest ERR', err && err.message || err);
        if (box) box.innerHTML = `<div class="empty">讀取失敗：${(err && err.message)||err}</div>`;
      })
      .getRecordLatest();
  }

  // —— 同步 dash KPI（只在 .kpi-list 存在時更新，不覆寫現有渲染流程）——
  function syncKpiFromLatest(latest){
    const kpiList = document.querySelector('.kpi-list');
    if (!kpiList) return; // dashboard 不在畫面就略過

    const map = {
      kpiTotal: latest.C,
      kpiNet:   Number(latest.C||0) - Number(latest.BB||0),
      kpiCash:  latest.G,
      kpiAvail: latest.E,
      // kpiUSD:   latest.CV,
      kpiDebt:  latest.BB
    };
    Object.entries(map).forEach(([id, val])=>{
      const el = document.getElementById(id);
      if (el) el.textContent = fmtNumTW(val);
    });
    const d = document.getElementById('kpiDate');
    if (d) d.textContent = latest.date || '—';
    const pnlEl = document.getElementById('dashPnlPill');
    if (pnlEl){
      const n = Number(latest.F||0);
      const sign = n>0?'+':'';
      pnlEl.textContent = sign + fmtNumTW(n);
      pnlEl.classList.remove('pos','neg','zero');
      if (n>0) pnlEl.classList.add('pos'); else if (n<0) pnlEl.classList.add('neg'); else pnlEl.classList.add('zero');
    }
  }

  // —— 重建表格（呼叫 createVirtualTable）——
  function rebuildDbTable(){
    const tbody = document.getElementById('dbTbody');
    const thead = document.getElementById('dbThead');
    const spacer= document.getElementById('dbSpacer');
    if (tbody) tbody.innerHTML = '';
    if (thead) thead.innerHTML = '';
    if (spacer) spacer.style.height = '0px';

    App.state.dbView = createVirtualTable({
      viewportId:'dbViewport',
      spacerId:'dbSpacer',
      theadId:'dbThead',
      tbodyId:'dbTbody',
      pageSize:100,
      fetcher: (q, cb)=>{
        q.order = 'desc';
        google.script.run
          .withSuccessHandler(cb)
          .withFailureHandler(err=>{
            console.error('[record] getDatabaseRows ERR', err && err.message || err);
            const meta = document.getElementById('dbMeta');
            if (meta) meta.textContent = '讀取失敗：' + (err && err.message || err);
          })
          .getDatabaseRows(q);
      }
    });
  }

  // —— 綁操作列（保留原本按鈕；新的狀態列不再包含這兩顆）——
  function initDatabaseView(){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('show'));
    document.getElementById('page-record')?.classList.add('show');

    const btnReload = document.getElementById('btnRecordReload');
    const btnAdd    = document.getElementById('btnRecordAddRow');

    if (btnReload) btnReload.onclick = ()=>{
      const pill = document.getElementById('dbStatusPill');
      if (pill){ pill.style.display='inline-block'; pill.textContent='重新載入中…'; pill.className='pill zero'; }
      loadRecordLatest();
      rebuildDbTable();
      if (pill) setTimeout(()=>{ pill.style.display='none'; }, 800);
    };

    if (btnAdd) btnAdd.onclick = ()=>{
      const pill = document.getElementById('dbStatusPill');
      if (pill){ pill.style.display='inline-block'; pill.textContent='處理中…'; pill.className='pill zero'; }
      google.script.run
        .withSuccessHandler((res)=>{
          if (pill){ pill.textContent = (res && res.msg) || '已新增一列'; pill.className='pill pos'; setTimeout(()=>{ pill.style.display='none'; }, 1500); }
          loadRecordLatest();
          rebuildDbTable();
        })
        .withFailureHandler(err=>{
          if (pill){ pill.textContent = '新增失敗：' + ((err && err.message) || err); pill.className='pill neg'; }
        })
        .runRecordAddRow();
    };

    loadRecordLatest();
    rebuildDbTable();
  }

  // —— 對外註冊 —— 
  window.initDatabaseView = initDatabaseView;
  window.loadRecordLatest = loadRecordLatest;
})();
</script>