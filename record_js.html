<script>
  (function () {
    window.App = window.App || {};
    App.state = App.state || {};
    App.state.dbOpen = { rowIndex: null };

    // —— 數字與膠囊 ——
    function fmtNumTW(n, opt = { minimumFractionDigits: 1, maximumFractionDigits: 1 }) {
      return Number(n || 0).toLocaleString('zh-Hant-TW', opt);
    }
    function maskHTML(v) { return `<span class="mask-num" data-mask-str="＊＊＊">${v}</span>`; }
    function pnlBadgeHTML(v) {
      const n = Number(v || 0);
      const cls = n > 0 ? 'roi-badge pos' : n < 0 ? 'roi-badge neg' : 'roi-badge zero';
      const sign = n > 0 ? '+' : '';
      return `<span class="${cls}">${maskHTML(sign + fmtNumTW(n))}</span>`;
    }

    // —— 虛擬表 ——
    function createVirtualTable({ viewportId, spacerId, theadId, tbodyId, fetcher, pageSize = 100 }) {
      const state = {
        rowHeight: 40,
        pageSize,
        pageCache: new Map(),
        total: 0,
        headers: [],
        viewport: document.getElementById(viewportId),
        spacer: document.getElementById(spacerId),
        thead: document.getElementById(theadId),
        tbody: document.getElementById(tbodyId),
        viewportH: 0,
        lastRange: [-1, -1],
        fetching: new Set(),
        pnlColIdx: -1,
        dateColIdx: 0
      };
      function isNumericLike(x) {
        if (typeof x === 'number') return true;
        if (typeof x !== 'string') return false;
        if (x.indexOf('<') !== -1) return false; // 已含 HTML，不再包
        return /[0-9]/.test(x);
      }
      function wrapCell(x) { return isNumericLike(x) ? maskHTML(String(x)) : String(x); }
      function renderCell(c, colIdx) {
        if (state.pnlColIdx === colIdx) {
          return pnlBadgeHTML(c);
        }
        if (state.dateColIdx === colIdx) {
          // 日期欄直接輸出文字，不套遮罩
          return String(c ?? '');
        }
        return wrapCell(c);
      }
      function onResize() { state.viewportH = state.viewport.clientHeight; render(); }
      let tick = null;
      function onScroll() { if (tick) return; tick = requestAnimationFrame(() => { render(); tick = null; }); }

      function render() {
        const top = state.viewport.scrollTop;
        const start = Math.max(0, Math.floor(top / state.rowHeight) - 20);
        const need = Math.ceil(state.viewportH / state.rowHeight) + 40;
        const end = Math.min(state.total, start + need);

        const p1 = Math.floor(start / state.pageSize);
        const p2 = Math.floor(Math.max(0, end - 1) / state.pageSize);
        for (let p = p1; p <= p2; p++) {
          if (!state.pageCache.has(p)) fetchPage(p);
        }
        if (state.lastRange[0] === start && state.lastRange[1] === end) return;
        state.lastRange = [start, end];

        const rows = [];
        for (let i = start; i < end; i++) {
          const p = Math.floor(i / state.pageSize);
          const j = i % state.pageSize;
          const page = state.pageCache.get(p);
          rows.push(page && page[j] ? page[j] : null);
        }

        state.tbody.style.transform = `translateY(${start * state.rowHeight}px)`;
        state.tbody.innerHTML = rows.map((r, idx) => {
          const isLatest = (start + idx === 0); // 第一筆 = 最新
          const trCls = isLatest ? 'is-latest' : '';
          if (!r) return `<tr class="${trCls}" style="height:${state.rowHeight}px"><td colspan="${state.headers.length || 1}">載入中…</td></tr>`;
          const monthMeta = (Array.isArray(r) && r.length > 6) ? (r[6] || '') : '';
          const gidx = start + idx; // 0=視圖最上面那筆（最新）
          const sheetRow = state.lastUsedRow ? (state.lastUsedRow - gidx) : '';
          const cellsHTML = r.slice(0, 6).map((c, colIdx) => `<td>${renderCell(c, colIdx)}</td>`).join('');
          return `<tr class="${trCls}" data-row="${gidx}" data-rownum="${sheetRow}" data-month="${String(monthMeta).replace(/"/g, '&quot;')}" style="height:${state.rowHeight}px">${cellsHTML}</tr>`;
        }).join('');
      }

      function fetchPage(pageIndex) {
        if (state.fetching.has(pageIndex)) return;
        state.fetching.add(pageIndex);
        const offset = pageIndex * state.pageSize;
        fetcher({ offset, limit: state.pageSize }, (res) => {
          state.fetching.delete(pageIndex);
          if (!res) { console.warn('[record] 空頁回傳'); return; }
          state.lastUsedRow = Number(res.lastUsedRow || 0) || state.lastUsedRow || 0;
          // 只顯示 A/C/D/E/F/G 六欄，固定表頭
          state.headers = ['日期', '總金額', '總金額-含dad', '可動用', '損益', '可用現金'];
          state.thead.innerHTML = `<tr>${state.headers.map(h => `<th>${h || ''}</th>`).join('')}</tr>`;
          state.dateColIdx = 0; // 日期固定第一欄
          state.pnlColIdx = 4; // 損益固定第 5 欄
          if (typeof res.total === 'number') {
            state.total = res.total;
            state.spacer.style.height = (state.total * state.rowHeight) + 'px';
          }
          if (!state.lastUsedRow && typeof state.total === 'number') {
            // 資料從第 3 列開始 → 實際最後一列 = total + 2
            state.lastUsedRow = 2 + state.total;
          }
          const allRows = Array.isArray(res.rows) ? res.rows : [];
          // 取 A/C/D/E/F/G，並把 B(月份) 放在索引 6 作為隱藏欄位
          const trimmedRows = allRows.map(r => [r[0], r[2], r[3], r[4], r[5], r[6], r[1]]);
          state.pageCache.set(pageIndex, trimmedRows);
          render();
          const meta = document.getElementById('dbMeta');
          if (meta) meta.textContent = `總筆數：${(state.total || 0).toLocaleString('zh-Hant-TW')}　每頁載入：${state.pageSize}　欄位數：${state.headers.length}`;
        });
      }

      state.viewport.addEventListener('scroll', onScroll);
      window.addEventListener('resize', onResize);
      onResize();
      fetchPage(0);

      // 點擊主列 → 選定（不再開啟子清單）
      state.tbody.addEventListener('click', (ev) => {
        const tr = ev.target.closest('tr');
        if (!tr) return;
        const rowIndex = Number(tr.getAttribute('data-row')) || 0;

        // 切換選中狀態
        state.tbody.querySelectorAll('tr.is-selected').forEach(el => el.classList.remove('is-selected'));
        tr.classList.add('is-selected');
        App.state.dbOpen.rowIndex = rowIndex;
      });

      // 對外 refresh
      state.refresh = function () {
        state.pageCache.clear();
        state.total = 0;
        state.headers = ['日期', '總金額', '總金額-含dad', '可動用', '損益', '可用現金'];
        state.spacer.style.height = '0px';
        state.tbody.innerHTML = '';
        state.thead.innerHTML = '';
        state.viewport.scrollTop = 0;
        state.lastRange = [-1, -1];
        fetchPage(0);
      };
      return state;
    }

    // —— 最新摘要卡 ——（同步 dash KPI 用於保險起見）
    function loadRecordLatest() {
      const box = document.getElementById('dbLatestBox');
      if (box) box.innerHTML = `<div class="empty">載入中…</div>`;
      google.script.run
        .withSuccessHandler(res => {
          if (!res) { box.innerHTML = `<div class="empty">沒有資料</div>`; return; }
          const rows = [
            ['日期', (res && res.date) || '-'],
            ['總資產', maskHTML(fmtNumTW(res.C))],
            ['加上爸爸', maskHTML(fmtNumTW(res.D))],
            ['可動用', maskHTML(fmtNumTW(res.E))],
            ['當日損益', pnlBadgeHTML(res.F)],
            ['現金', maskHTML(fmtNumTW(res.G))],
            ['債務', maskHTML(fmtNumTW(res.BA))],
            ['持有 USD', maskHTML(fmtNumTW(res.CU))]
          ];
          box.innerHTML = rows.map(([k, v]) => `<div class="kv"><div class="k">${k}</div><div class="v">${v}</div></div>`).join('');
          syncKpiFromLatest(res); // 若 dash KPI 容器存在就同步
        })
        .withFailureHandler(err => {
          console.error('[record] getRecordLatest ERR', err && err.message || err);
          if (box) box.innerHTML = `<div class="empty">讀取失敗：${(err && err.message) || err}</div>`;
        })
        .getRecordLatest();
    }

    // —— 同步 dash KPI（只在 .kpi-list 存在時更新，不覆寫現有渲染流程）——
    function syncKpiFromLatest(latest) {
      const kpiList = document.querySelector('.kpi-list');
      if (!kpiList) return; // dashboard 不在畫面就略過

      const map = {
        kpiTotal: latest.C,
        kpiNet: latest.D,     // 以 D 欄 Whole Assets 為淨資產
        kpiCash: latest.G,
        kpiAvail: latest.E,
        kpiUSD: latest.CU     // 新增 USD；前端需有 id="kpiUSD"
        // 不再同步 kpiDebt
      };
      Object.entries(map).forEach(([id, val]) => {
        const el = document.getElementById(id);
        if (el) el.textContent = fmtNumTW(val);
      });
      const d = document.getElementById('kpiDate');
      if (d) d.textContent = latest.date || '—';
      const pnlEl = document.getElementById('dashPnlPill');
      if (pnlEl) {
        const n = Number(latest.F || 0);
        const sign = n > 0 ? '+' : '';
        pnlEl.textContent = sign + fmtNumTW(n);
        pnlEl.classList.remove('pos', 'neg', 'zero');
        if (n > 0) pnlEl.classList.add('pos'); else if (n < 0) pnlEl.classList.add('neg'); else pnlEl.classList.add('zero');
      }
    }

    // —— 重建表格（呼叫 createVirtualTable）——
    function rebuildDbTable() {
      const tbody = document.getElementById('dbTbody');
      const thead = document.getElementById('dbThead');
      const spacer = document.getElementById('dbSpacer');
      if (tbody) tbody.innerHTML = '';
      if (thead) thead.innerHTML = '';
      if (spacer) spacer.style.height = '0px';

      App.state.dbView = createVirtualTable({
        viewportId: 'dbViewport',
        spacerId: 'dbSpacer',
        theadId: 'dbThead',
        tbodyId: 'dbTbody',
        pageSize: 100,
        fetcher: (q, cb) => {
          q.order = 'desc';
          google.script.run
            .withSuccessHandler(cb)
            .withFailureHandler(err => {
              console.error('[record] getDatabaseRows ERR', err && err.message || err);
              const meta = document.getElementById('dbMeta');
              if (meta) meta.textContent = '讀取失敗：' + (err && err.message || err);
            })
            .getDatabaseRows(q);
        }
      });
    }

    // —— 綁操作列（保留原本按鈕；新的狀態列不再包含這兩顆）——
    function initDatabaseView() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('show'));
      document.getElementById('page-record')?.classList.add('show');

      const btnReload = document.getElementById('btnRecordReload');
      const btnAdd = document.getElementById('btnRecordAddRow');

      if (btnReload) btnReload.onclick = () => {
        const pill = document.getElementById('dbStatusPill');
        if (pill) { pill.style.display = 'inline-block'; pill.textContent = '重新載入中…'; pill.className = 'pill zero'; }
        loadRecordLatest();
        rebuildDbTable();
        if (pill) setTimeout(() => { pill.style.display = 'none'; }, 800);
      };

      if (btnAdd) btnAdd.onclick = () => {
        const pill = document.getElementById('dbStatusPill');
        if (pill) { pill.style.display = 'inline-block'; pill.textContent = '處理中…'; pill.className = 'pill zero'; }
        google.script.run
          .withSuccessHandler((res) => {
            if (pill) { pill.textContent = (res && res.msg) || '已新增一列'; pill.className = 'pill pos'; setTimeout(() => { pill.style.display = 'none'; }, 1500); }
            loadRecordLatest();
            rebuildDbTable();
          })
          .withFailureHandler(err => {
            if (pill) { pill.textContent = '新增失敗：' + ((err && err.message) || err); pill.className = 'pill neg'; }
          })
          .runRecordAddRow();
      };

      loadRecordLatest();
      rebuildDbTable();
      bindAnalyse();
    }

    let analyseData = [];
    let analyseSortDesc = true;

    // —— 變動分析 ——
    function bindAnalyse() {
      const btn = document.getElementById('btnRecordAnalyse');
      if (!btn) return;
      btn.onclick = () => {
        const idx = App.state.dbOpen.rowIndex;
        if (idx == null) {
          alert('請先點擊下方列表中的一列資料進行分析。');
          return;
        }

        btn.disabled = true;
        const pill = document.getElementById('dbStatusPill');
        if (pill) { pill.style.display = 'inline-block'; pill.textContent = '分析中…'; pill.className = 'pill zero'; }

        google.script.run
          .withSuccessHandler(data => {
            btn.disabled = false;
            if (pill) pill.style.display = 'none';
            if (!data || !data.length) {
              alert('此列與前一列相比，所有金額欄位均無差異。');
              return;
            }
            analyseData = data;
            analyseSortDesc = true;
            renderAnalyseContent();
            document.getElementById('dbAnalyseDlg').showModal();
          })
          .withFailureHandler(err => {
            btn.disabled = false;
            if (pill) { pill.textContent = '分析失敗'; pill.className = 'pill neg'; }
            alert('分析失敗：' + (err && err.message || err));
          })
          .getRecordDelta(idx);
      };

      document.getElementById('dbAnalyseOk').onclick = () => document.getElementById('dbAnalyseDlg').close();
      document.getElementById('dbAnalyseClose').onclick = () => document.getElementById('dbAnalyseDlg').close();
    }

    function renderAnalyseContent() {
      const wrap = document.getElementById('dbAnalyseResult');
      if (!wrap) return;

      // 計算總變動
      const totalDelta = analyseData.reduce((s, it) => s + (it.delta || 0), 0);
      const totalCls = totalDelta > 0 ? 'pos' : (totalDelta < 0 ? 'neg' : 'zero');
      const totalSign = totalDelta > 0 ? '+' : '';

      const titleBox = document.getElementById('dbAnalyseTitle');
      titleBox.innerHTML = `
        變動分析
        <span class="pill ${totalCls}" style="margin-left: 12px; font-size: 0.8em; padding: 2px 10px;">
          ${totalSign}${fmtNumTW(totalDelta, { maximumFractionDigits: 0 })}
        </span>
        <button id="btnAnalyseSort" class="btn-ghost" style="margin-left: 8px;" title="切換排序">
          <span class="material-symbols-outlined" style="font-size:18px;">${analyseSortDesc ? 'sort_by_alpha' : 'filter_list'}</span>
        </button>
      `;

      document.getElementById('btnAnalyseSort').onclick = () => {
        analyseSortDesc = !analyseSortDesc;
        renderAnalyseContent();
      };

      // 排序：預設絕對值由大到小
      const sorted = analyseData.slice().sort((a, b) => {
        const va = Math.abs(a.delta), vb = Math.abs(b.delta);
        return analyseSortDesc ? (vb - va) : (va - vb);
      });

      const html = `
        <table class="db-table-mini">
          <thead>
            <tr>
              <th><div class="th-ico"><span class="material-symbols-outlined">category</span>項目</div></th>
              <th class="num"><div class="th-ico" style="justify-content:flex-end;"><span class="material-symbols-outlined">history</span>前次金額</div></th>
              <th class="num"><div class="th-ico" style="justify-content:flex-end;"><span class="material-symbols-outlined">today</span>本次金額</div></th>
              <th class="num"><div class="th-ico" style="justify-content:flex-end;"><span class="material-symbols-outlined">change_circle</span>變動</div></th>
            </tr>
          </thead>
          <tbody>
            ${sorted.map(it => {
        const d = it.delta || 0;
        const dCls = d > 0 ? 'pos' : (d < 0 ? 'neg' : 'zero');
        const dSign = d > 0 ? '+' : '';
        const prevCls = it.previous < 0 ? 'neg' : '';
        const curCls = it.current < 0 ? 'neg' : '';
        return `
              <tr>
                <td style="white-space:nowrap;">${it.label}</td>
                <td class="num ${prevCls} mask-num" data-mask-str="＊＊＊">${fmtNumTW(it.previous, { maximumFractionDigits: 0 })}</td>
                <td class="num ${curCls} mask-num" data-mask-str="＊＊＊">${fmtNumTW(it.current, { maximumFractionDigits: 0 })}</td>
                <td class="num ${dCls} mask-num" data-mask-str="＊＊＊"><b>${dSign}${fmtNumTW(d, { maximumFractionDigits: 0 })}</b></td>
              </tr>`;
      }).join('')}
          </tbody>
        </table>
      `;
      wrap.innerHTML = html;
    }

    // —— 對外註冊 —— 
    window.initDatabaseView = initDatabaseView;
    window.loadRecordLatest = loadRecordLatest;

    // 對外註冊 App.pages.record
    App.pages = App.pages || {};
    App.pages.record = {
      init: initDatabaseView,
      refresh: () => {
        // 模擬 btnRecordReload 行為
        loadRecordLatest();
        // rebuildDbTable 會重置虛擬表並重新 fetchPage(0)
        rebuildDbTable();
      }
    };
  })();
</script>