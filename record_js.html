<script>
  (function () {
    window.App = window.App || {};
    App.state = App.state || {};

    // State
    let currentDate = null; // null = latest
    let currentRawDate = ''; // 'YYYY-MM-DD'
    let isBusy = false;
    let validDatesMap = {}; // 'YYYY-MM-DD': true

    // Helpers
    function fmtNum(n) { return Number(n || 0).toLocaleString('zh-Hant-TW', { minimumFractionDigits: 1, maximumFractionDigits: 1 }); }
    function fmtInt(n) { return Number(n || 0).toLocaleString('zh-Hant-TW', { maximumFractionDigits: 0 }); }
    function fmtDiff(n) { const v = Number(n || 0); return (v > 0 ? '+' : '') + fmtInt(v); }
    function getCls(n) { return n > 0 ? 'pos' : (n < 0 ? 'neg' : 'zero'); }
    function maskVal(v) { return String(v).replace(/[0-9,\.\+\-]+/g, '<span class="mask-num" data-mask-str="***">$&</span>'); }

    // Main Entry
    function initDatabaseView() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('show'));
      document.getElementById('page-record')?.classList.add('show');

      bindEvents();
      loadDashboard(null); // Load latest
    }

    function bindEvents() {
      // Prev/Next Smart Navigation
      byId('dbPrevDay').onclick = () => loadDashboard(currentRawDate, 'prev');
      byId('dbNextDay').onclick = () => loadDashboard(currentRawDate, 'next');

      // Date Display -> Custom Modal
      const display = byId('dbDateDisplay');
      if (display) display.onclick = showCalendarModal;

      // Actions
      byId('btnRecordReload').onclick = () => loadDashboard(currentRawDate || null);
      byId('btnRecordAddRow').onclick = runAddRow;
    }

    function byId(id) { return document.getElementById(id); }

    function toggleBusy(b) {
      isBusy = b;
      const ov = byId('dbStatusOverlay');
      if (ov) ov.classList.toggle('hidden', !b);
    }

    function loadDashboard(dateStr, logicType) {
      if (isBusy) return;
      toggleBusy(true);

      google.script.run
        .withSuccessHandler(res => {
          toggleBusy(false);
          if (res.error) {
            console.warn(res.error);
            if (res.error === 'Date not found') alert('該日期無資料');
            return;
          }
          validDatesMap = res.validDates || {};
          renderDashboard(res);
        })
        .withFailureHandler(err => {
          toggleBusy(false);
          console.error(err);
          alert('載入失敗');
        })
        .getRecordByDate(dateStr, logicType);
    }

    function renderDashboard(res) {
      const cur = res.current;
      const prev = res.previous || {};

      // 1. Update Date UI
      const dStr = cur.Date || '';
      let dateObj = new Date(dStr);
      if (isNaN(dateObj.getTime())) {
        dateObj = new Date(); // Fallback to now
        currentRawDate = dateObj.toISOString().split('T')[0];
      } else {
        currentRawDate = dStr;
      }
      currentDate = currentRawDate;

      const dayMap = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

      byId('dbCurrentDate').textContent = currentRawDate;
      byId('dbDateSub').textContent = dayMap[dateObj.getDay()];

      // Keep input sync
      const dp = byId('dbDateInput');
      if (dp) dp.value = currentRawDate;

      // 2. Render Pinned Stats
      // C: Total, D: Net, E: Avail(Actionable), F: PnL, G: Cash(Available)
      setText('dbPinTotal', cur.Total);
      setText('dbPinNet', cur.Net);
      setText('dbPinAction', cur.E);
      const pnl = Number(cur.F || 0);
      const elPnl = byId('dbPinPnL');
      if (elPnl) {
        elPnl.innerHTML = fmtInt(pnl);
        elPnl.className = 'stat-main mask-num ' + getCls(pnl);
      }
      setText('dbPinAvail', cur.G);

      // 3. Render Details
      renderDetailsGrid(res);
    }

    function setText(id, val) {
      const el = byId(id);
      if (el) el.innerHTML = maskVal(fmtInt(val));
    }


    function renderDetailsGrid(res) {
      const grid = byId('dbDetailsGrid');
      if (!grid) return;
      grid.innerHTML = '';

      const cur = res.current || {};
      const prev = res.previous || {};
      const headersMain = res.headersMain || [];
      const headersSub = res.headersSub || [];

      const full = cur.full || [];
      const prevFull = prev.full || [];

      const SKIP_INDICES = [0, 1, 2, 3, 4, 5, 6]; // A-G

      // Collect Items
      let items = [];
      full.forEach((val, idx) => {
        if (SKIP_INDICES.includes(idx)) return;

        const numVal = Number(val);
        if (isNaN(numVal) || (numVal === 0 && !val)) return;

        const mainH = (headersMain[idx] || '其他 (Others)').trim();
        const subH = (headersSub[idx] || `Col ${idx + 1}`).trim();
        const prevVal = Number(prevFull[idx] || 0);
        const diff = numVal - prevVal;

        items.push({ group: mainH, label: subH, val: numVal, diff: diff });
      });

      // 3-Tier Grouping
      const tiers = {
        'Increase': items.filter(i => i.diff > 0),
        'Decrease': items.filter(i => i.diff < 0),
        'No Change': items.filter(i => i.diff === 0)
      };

      const renderTier = (tierTitle, tierItems) => {
        if (tierItems.length === 0) return;

        // Tier Heading
        const tierContainer = document.createElement('div');
        tierContainer.className = 'tier-container';
        tierContainer.style.gridColumn = '1 / -1';
        tierContainer.style.borderBottom = '1px solid var(--hairline)';
        tierContainer.style.padding = '16px 0 8px 0';
        tierContainer.style.marginBottom = '16px';
        tierContainer.style.fontWeight = '700';
        tierContainer.style.color = varColorForTier(tierTitle);
        tierContainer.innerHTML = `<div style="font-size:18px; display:flex; align-items:center; gap:8px;">${iconForTier(tierTitle)} ${tierTitle}</div>`;
        grid.appendChild(tierContainer);

        // Group by Main Header within Tier
        const subGroups = {};
        tierItems.forEach(it => {
          const g = it.group || 'Other';
          if (!subGroups[g]) subGroups[g] = [];
          subGroups[g].push(it);
        });

        Object.keys(subGroups).forEach(gName => {
          const card = document.createElement('div');
          card.className = 'card detail-group-card';

          const hd = document.createElement('div');
          hd.className = 'detail-group-hd';
          hd.innerHTML = `<span class="material-symbols-outlined icon-sm">folder</span><span>${gName}</span>`;
          card.appendChild(hd);

          subGroups[gName].forEach(it => {
            const row = document.createElement('div');
            row.className = 'detail-row';

            const cls = getCls(it.diff);
            const diffStr = (it.diff !== 0) ? `<span class="monolith-label diff-tiny ${cls}">${fmtDiff(it.diff)}</span>` : '';

            row.innerHTML = `
                       <div class="detail-label monolith-symbol">${it.label}</div>
                       <div class="detail-right">
                          ${diffStr}
                          <span class="detail-val monolith-price mask-num">${fmtInt(it.val)}</span>
                       </div>
                     `;
            card.appendChild(row);
          });

          grid.appendChild(card);
        });
      };

      renderTier('Increase', tiers['Increase']);
      renderTier('Decrease', tiers['Decrease']);
      renderTier('No Change', tiers['No Change']);
    }

    function varColorForTier(t) {
      if (t === 'Increase') return 'var(--tone-pos-fg)';
      if (t === 'Decrease') return 'var(--tone-neg-fg)';
      return 'var(--muted)';
    }
    function iconForTier(t) {
      if (t === 'Increase') return '<span class="material-symbols-outlined">trending_up</span>';
      if (t === 'Decrease') return '<span class="material-symbols-outlined">trending_down</span>';
      return '<span class="material-symbols-outlined">remove</span>';
    }

    function runAddRow() {
      if (!confirm('確定要新增一列嗎？\n(這會凍結今日並建立新的一行)')) return;
      toggleBusy(true);
      google.script.run
        .withSuccessHandler(res => {
          alert(res.msg || 'Done');
          loadDashboard(null);
        })
        .withFailureHandler(err => {
          toggleBusy(false);
          alert('Add Failed: ' + err);
        })
        .runRecordAddRow();
    }

    // --- Custom Calendar Modal ---
    function showCalendarModal() {
      // Singleton check
      let dlg = byId('dbCalDlg');
      if (dlg) {
        // If it exists but is closed, just open it.
        // If it sends "open" attribute natively it might be true.
        // We re-render body anyway.
        if (!dlg.open) {
          renderCalendarBody(new Date(currentRawDate));
          dlg.showModal();
        }
        return;
      }

      // Create new if not exists
      dlg = document.createElement('dialog');
      dlg.id = 'dbCalDlg';
      dlg.className = 'dlg-modal';
      // ... html
      dlg.innerHTML = `
           <div class="dlg-box cal-box">
              <header class="dlg-hd">
                <div class="dlg-title">Select Date</div>
                <button class="dlg-close" id="btnCloseCal"><span class="material-symbols-outlined">close</span></button>
              </header>
              <div class="dlg-bd" id="calBody"></div>
           </div>`;
      document.body.appendChild(dlg);

      // Bind Close
      dlg.querySelector('#btnCloseCal').onclick = () => dlg.close();

      dlg.addEventListener('click', (e) => {
        if (e.target === dlg) dlg.close();
      });

      renderCalendarBody(new Date(currentRawDate));
      dlg.showModal();
      renderCalendarBody(new Date(currentRawDate));
      dlg.showModal();
    }

    function renderCalendarBody(refDate) {
      const body = byId('calBody');
      body.innerHTML = '';

      const y = refDate.getFullYear();
      const m = refDate.getMonth();

      const nav = document.createElement('div');
      nav.className = 'cal-nav';
      nav.innerHTML = `
          <button id="calPrevM"><span class="material-symbols-outlined">chevron_left</span></button>
          <span>${y} / ${m + 1}</span>
          <button id="calNextM"><span class="material-symbols-outlined">chevron_right</span></button>
        `;
      body.appendChild(nav);

      const grid = document.createElement('div');
      grid.className = 'cal-grid';

      ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => {
        const th = document.createElement('div');
        th.className = 'cal-head';
        th.innerText = d;
        grid.appendChild(th);
      });

      const firstDay = new Date(y, m, 1).getDay();
      const daysInMonth = new Date(y, m + 1, 0).getDate();

      for (let i = 0; i < firstDay; i++) {
        grid.appendChild(document.createElement('div'));
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        // Normalize month/day to 2-digits for YYYY-MM-DD exact match
        const iso = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

        cell.innerText = d;
        if (validDatesMap[iso]) cell.classList.add('has-data'); else cell.classList.add('no-data');
        if (iso === currentRawDate) cell.classList.add('selected');
        cell.onclick = () => {
          if (validDatesMap[iso]) {
            document.getElementById('dbCalDlg').close();
            loadDashboard(iso);
          } else {
            alert('No data for this date');
          }
        };
        grid.appendChild(cell);
      }

      body.appendChild(grid);
      byId('calPrevM').onclick = () => renderCalendarBody(new Date(y, m - 1, 1));
      byId('calNextM').onclick = () => renderCalendarBody(new Date(y, m + 1, 1));
    }

    // Export
    App.pages.record = {
      init: initDatabaseView,
      refresh: () => loadDashboard(currentRawDate || null)
    };
    // Supporting global go() call
    window.initDatabaseView = initDatabaseView;
  })();
</script>