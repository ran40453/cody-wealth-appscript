<!-- invest_js.html -->
<script>
    window.App = window.App || {};
    window.API = window.API || {};

    App.modules = App.modules || {};

    App.modules.invest = App.modules.invest || (function () {
        // ===== state =====
        let allRows = [];
        let viewRows = [];
        let currentCategory = '基金'; // 預設類別
        let currentView = 'details'; // 'analysis' | 'details'
        let isKpiCollapsed = false;

        const CHIP_ORDER = ['基金', '債券', '定存', '其他'];
        const vs = { rowHeight: 44, viewport: null, spacer: null, thead: null, tbody: null, lastRange: [-1, -1] };

        // ===== init =====
        function init() {
            setupKpiToggle();
            setupViewport();
            renderHead();
            setBodyLoading(true);
            fetchData();
        }

        // ===== Side Toggle =====
        function setupKpiToggle() {
            const btn = byId('kpiSideToggle');
            if (btn) btn.onclick = toggleKpiSidebar;
        }

        function toggleKpiSidebar() {
            isKpiCollapsed = !isKpiCollapsed;
            const shell = document.querySelector('.analysis-split');
            if (shell) shell.classList.toggle('collapsed', isKpiCollapsed);
            // 延遲渲染虛擬列表以適應新寬度
            setTimeout(() => { if (typeof renderVirtual === 'function') renderVirtual(); }, 300);
        }

        function switchView(view) {
            currentView = view;
            const isStock = (currentCategory === '股票');

            // 確保含有 KPI 的分析視圖永遠開啟，僅切換右側內容
            byId('investAnalysisView').classList.add('active');

            if (isStock) {
                byId('investMiniTable').style.display = 'none';
                byId('investStockView').style.display = 'block';
                // 股票模式時自動展開以顯示市場統計
                const shell = document.querySelector('.analysis-split');
                if (shell) shell.classList.remove('collapsed');
            } else {
                byId('investMiniTable').style.display = 'block';
                byId('investStockView').style.display = 'none';
                const shell = document.querySelector('.analysis-split');
                if (shell) shell.classList.toggle('collapsed', isKpiCollapsed);
                renderVirtual();
            }
        }

        // ===== Chips / Categories =====
        function renderCategories(kinds) {
            const box = byId('investChips'); if (!box) return;
            kinds = Array.isArray(kinds) ? kinds.filter(k => String(k || '').trim() !== '類型') : [];
            const cleanKinds = kinds.map(k => String(k || '').trim()).filter(Boolean);
            const union = new Set([...CHIP_ORDER, ...cleanKinds]);
            const arr = Array.from(union);

            const rank = new Map(CHIP_ORDER.map((k, i) => [k, i]));
            arr.sort((a, b) => {
                const ia = rank.has(a) ? rank.get(a) : 999;
                const ib = rank.has(b) ? rank.get(b) : 999;
                return ia - ib;
            });

            box.innerHTML = arr.map(k => `
        <button class="invest-side-btn ${currentCategory === k ? 'active' : ''}" data-type="${esc(k)}">
          <span class="dot"></span>
          <span class="label">${esc(k)}</span>
          <span class="material-symbols-outlined arrow">chevron_right</span>
        </button>
      `).join('');

            box.querySelectorAll('.invest-side-btn').forEach(el => {
                el.addEventListener('click', () => {
                    box.querySelectorAll('.invest-side-btn').forEach(b => b.classList.remove('active'));
                    el.classList.add('active');
                    currentCategory = el.dataset.type;

                    // 切換分類時關閉細節卡片
                    if (window.App?.modules?.stk) App.modules.stk.closeDetail();
                    if (typeof closeCategoryDetail === 'function') closeCategoryDetail();

                    if (currentCategory === '股票') {
                        switchView('details');
                    } else {
                        switchView(currentView);
                    }
                    applyFilter();
                });
            });
        }

        // ===== Viewport / Virtual =====
        function setupViewport() {
            vs.viewport = byId('investViewport');
            vs.spacer = byId('investSpacer');
            vs.thead = byId('investHead');
            vs.tbody = byId('investBody');
            if (!vs.viewport) return;

            ensureAFBinding();
            ensureRowClickBinding();

            let raf = null;
            vs.viewport.addEventListener('scroll', () => {
                if (raf) return;
                raf = requestAnimationFrame(() => { raf = null; renderVirtual(); });
            });
        }

        // ===== Data Fetching =====
        function fetchData() {
            if (!(window.google && window.google.script && window.google.script.run)) {
                setTimeout(fetchData, 500);
                return;
            }
            google.script.run
                .withSuccessHandler(rows => {
                    allRows = Array.isArray(rows) ? rows.filter(r => r.K && !String(r.K).includes('總計')) : [];
                    allRows.forEach(r => {
                        const hVal = String(r.H || '').trim();
                        r.TYPE = hVal || guessType(r.K || '');
                    });
                    const kinds = Array.from(new Set(allRows.map(r => r.TYPE).filter(Boolean)));
                    renderCategories(kinds);
                    applyFilter();
                })
                .withFailureHandler(err => {
                    console.error('[Invest] load error:', err);
                    failUI((err && err.message) || '讀取失敗');
                })
                .getCTBCInvestments();
        }

        function applyFilter() {
            viewRows = allRows.filter(r => r.TYPE === currentCategory);
            showStatus('更新中…');
            renderKPI(viewRows);
            switchView(currentView);

            if (currentCategory === '股票' && window.App?.modules?.stk) {
                window.App.modules.stk.init();
                if (typeof App.modules.stk.renderMarketsCard === 'function') {
                    App.modules.stk.renderMarketsCard();
                }
            } else {
                renderAddButton();
            }
            // 渲染完成後清除狀態
            setTimeout(clearStatus, 500);
        }

        // ===== KPI Rendering =====
        function renderKPI(rows) {
            // console.log('[invest] renderKPI rows:', rows.length, 'Category:', currentCategory);
            const sum = k => rows.reduce((s, r) => {
                const val = toNum(r[k]);
                // Debug Loan/Growin specifically
                if ((currentCategory === 'Loan' || currentCategory === 'Growin') && (k === 'M' || k === 'L')) {
                    // console.log(` > ${r.B}: Summing col ${k} = ${val}`);
                }
                return s + val;
            }, 0);
            const totalMV = sum('N');     // 現值 (N)
            const totalPL = sum('G');     // 損益 (G)
            const totalAF = sum('AF');    // 利息 (AF)
            // console.log('[invest] Totals -> MV:', totalMV, 'PL:', totalPL, 'AF:', totalAF);
            // console.log('[invest] TWD(M):', sum('M'), 'USD(L):', sum('L'));

            setText('investTWD_N', sum('M').toFixed(0));
            setText('investUSD_N', sum('L').toFixed(0));
            if (typeof setPnlPill === 'function') {
                const isUSD = ['基金', '債券'].includes(currentCategory);
                setPnlPill('investTWD_ROI', isUSD ? null : roi);
                setPnlPill('investUSD_ROI', isUSD ? roi : null);
            }

            // 總 ROI
            let totalROI = null;
            if (currentCategory === '股票') {
                const totalCost = sum('L'); // 股票 L 欄為成本
                if (totalCost) totalROI = (totalPL / totalCost * 100);
            } else {
                const totalCost = sum('K');
                if (totalCost) totalROI = (totalPL / totalCost * 100);
                else {
                    const totalN = sum('N');
                    const totalT = sum('T');
                    const fallbackCost = totalN - totalT;
                    if (fallbackCost > 0) totalROI = (totalT / fallbackCost * 100);
                }
            }
            if (typeof setPnlPill === 'function') setPnlPill('investAllROI', totalROI);

            const twdRows = rows.filter(r => {
                const cur = String(r.V || r.CUR || '').toUpperCase();
                return cur.includes('TW') || cur.includes('NT');
            });
            const usdRows = rows.filter(r => {
                const cur = String(r.V || r.CUR || '').toUpperCase();
                return cur.includes('USD');
            });

            const twdMV = twdRows.reduce((s, r) => s + toNum(r.M), 0);
            const usdMV = usdRows.reduce((s, r) => s + toNum(r.L), 0);

            // 如果是股票類別，嘗試從全域變數獲取最新值 (由 stk 模組提供)
            if (currentCategory === '股票' && window.__stkMarketsMV__) {
                setText('investTWD_N', window.__stkMarketsMV__.toFixed(0));
                // 簡單匯率轉換或由後端提供
                setText('investUSD_N', (window.__stkMarketsMV__ / 32).toFixed(0));
            } else {
                setText('investTWD_N', twdMV.toFixed(0));
                setText('investUSD_N', usdMV.toFixed(0));
            }

            const getGroupROI = (gRows) => {
                if (!gRows.length) return null;
                const totalPL = gRows.reduce((s, r) => s + toNum(r.G), 0);
                const totalMV = gRows.reduce((s, r) => s + toNum(r.N), 0);
                const cost = totalMV - totalPL;
                return cost > 0 ? (totalPL / cost * 100) : 0;
            };

            const twdROI = getGroupROI(twdRows);
            const usdROI = getGroupROI(usdRows);

            if (typeof setPnlPill === 'function') {
                setPnlPill('investTWD_ROI', twdROI);
                setPnlPill('investUSD_ROI', usdROI);
            }

            renderAddButton();
        }

        function renderAddButton() {
            const container = byId('investAddAction');
            if (!container) return;
            container.innerHTML = `
                <button class="btn" onclick="App.modules.invest.showAddPrompt()" 
                        style="width:100%; display:flex; align-items:center; justify-content:center; gap:10px; padding:15px; color:var(--tint); font-weight:600; border-radius:16px;">
                    <span class="material-symbols-outlined">add_circle</span>
                    新增 ${esc(currentCategory)} 項目
                </button>
            `;
        }

        function showAddPrompt() {
            const name = prompt(`請輸入新的 [${currentCategory}] 項目名稱:`);
            if (!name) return;

            toggleBusy(true);
            google.script.run
                .withSuccessHandler((res) => {
                    toggleBusy(false);
                    if (typeof fetchData === 'function') fetchData();
                    alert(`新增完成: ${name}`);
                })
                .withFailureHandler(err => {
                    console.error('[invest] addInvestEntry error:', err);
                    toggleBusy(false);
                    alert('新增失敗: ' + (err?.message || '未知錯誤'));
                })
                .addInvestEntry(currentCategory, name);
        }

        function renderCategoryDetailCard(rowId) {
            const container = byId('investDetailCardContainer');
            if (!container) return;
            const r = allRows.find(x => x.ROW === rowId);
            if (!r) return;

            if (window.App?.modules?.stk) App.modules.stk.closeDetail();

            const pl = toNum(r.G);
            const mv = toNum(r.N);
            const cost = mv - pl;
            const roi = cost > 0 ? (pl / cost * 100) : 0;

            container.innerHTML = `
                <div class="card stk-details-card damping-open" style="margin-top:20px;">
                    <div class="card-hd">
                        <span class="material-symbols-outlined">analytics</span>
                        <strong>產品詳情：${esc(r.K || '-')}</strong>
                        <button class="btn-ghost" onclick="App.modules.invest.closeCategoryDetail()" style="margin-left:auto;"><span class="material-symbols-outlined">close</span></button>
                    </div>
                    <div class="stk-detail-grid" style="display:grid; grid-template-columns: 1fr; gap:0px; padding:0px;">
                        <div class="detail-info">
                            <!-- Monolith Style Box (Integrated) -->
                            <div class="monolith-card" style="background:var(--card); box-shadow:var(--neu-pressed); border:1px solid var(--hairline); color:var(--text); background-image:none; padding:24px; border-radius:20px;">
                                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:24px;">
                                    <div>
                                        <div class="monolith-symbol" style="color:var(--text); font-size:32px; font-weight:900;">${esc(r.K?.split(' ')[0] || r.K || 'INV')}</div>
                                        <div class="monolith-label">Terminal / Asset Profile</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div class="monolith-price" style="font-size:36px; font-weight:900;">$${fmtMoney(r.N)}</div>
                                        <div style="margin-top:4px;">${roiChipHTML(roi)}</div>
                                    </div>
                                </div>
                                
                                <!-- Integrated Info & Action Grid -->
                                <div style="display:grid; grid-template-columns: 1fr; gap:16px; padding-top:24px; border-top:1px solid color-mix(in oklab, var(--text) 5%, transparent);">
                                    
                                    <!-- Row 1: Shares & Value -->
                                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                                        <div class="mono-item">
                                            <div class="monolith-label" style="margin-bottom:4px;">單位數量</div>
                                            <div style="font-family:'JetBrains Mono'; font-weight:700; font-size:18px;">${esc(r.U)}</div>
                                        </div>
                                        <div class="mono-item">
                                            <div class="monolith-label" style="margin-bottom:4px;">目前市值</div>
                                            <div style="font-family:'JetBrains Mono'; font-weight:700; font-size:18px;">$${fmtMoney(r.N)}</div>
                                        </div>
                                    </div>

                                    <!-- Row 2: Quote/Net Val (Editable) -->
                                    <div style="display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:end;">
                                        <div class="mono-item">
                                            <div class="monolith-label" style="margin-bottom:4px;">最新報價 / 淨值</div>
                                            <input type="number" step="any" value="${toNum(r.R)}" id="catInputR" class="input" 
                                                   style="background:rgba(0,0,0,0.03); border:none; font-family:'JetBrains Mono'; font-weight:700; font-size:16px; padding:8px 12px; border-radius:8px; width:100%;">
                                        </div>
                                        <button class="btn-mini" onclick="App.modules.invest.updateCategoryField(${rowId}, 'R', 'catInputR')" 
                                                style="height:38px; padding:0 15px; border-radius:8px; font-size:12px;">更新</button>
                                    </div>

                                    <!-- Row 3: Accumulated Interest/Profit (Editable) -->
                                    <div style="display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:end;">
                                        <div class="mono-item">
                                            <div class="monolith-label" style="margin-bottom:4px;">累計利息 / 損益</div>
                                            <input type="number" step="any" value="${toNum(r.AF)}" id="catInputAF" class="input" 
                                                   style="background:rgba(0,0,0,0.03); border:none; font-family:'JetBrains Mono'; font-weight:700; font-size:16px; padding:8px 12px; border-radius:8px; width:100%;">
                                        </div>
                                        <button class="btn-mini" onclick="App.modules.invest.updateCategoryField(${rowId}, 'AF', 'catInputAF')"
                                                style="height:38px; padding:0 15px; border-radius:8px; font-size:12px;">更新</button>
                                    </div>

                                    <!-- Row 4: Remarks -->
                                    <div class="mono-item">
                                        <div class="monolith-label" style="margin-bottom:4px;">備註說明</div>
                                        <div style="font-size:13px; opacity:0.8; padding:8px 0;">${esc(r.AH || '-')}</div>
                                    </div>

                                    <!-- Row 5: Status Toggle -->
                                    <div class="mono-item">
                                        <div class="monolith-label" style="margin-bottom:8px;">資產狀態</div>
                                        <div class="seg" style="display:flex; background:rgba(0,0,0,0.05); border-radius:10px; padding:3px; gap:4px;">
                                            <button onclick="App.modules.invest.updateCategoryField(${rowId}, 'AI', '1')" 
                                                    style="flex:1; border:none; background:${isActive ? 'var(--card)' : 'transparent'}; color:${isActive ? 'var(--tint)' : 'var(--muted)'}; padding:8px; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer; box-shadow:${isActive ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'};">
                                                持有中
                                            </button>
                                            <button onclick="App.modules.invest.updateCategoryField(${rowId}, 'AI', '0')" 
                                                    style="flex:1; border:none; background:${!isActive ? 'var(--card)' : 'transparent'}; color:${!isActive ? 'var(--tint)' : 'var(--muted)'}; padding:8px; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer; box-shadow:${!isActive ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'};">
                                                已結算
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateCategoryField(rowId, colKey, inputId) {
            const input = byId(inputId);
            if (!input) return;
            const val = input.value;
            showStatus('更新中...');
            google.script.run
                .withSuccessHandler(() => {
                    clearStatus();
                    fetchData();
                    // 重新開啟後選中 (可能需要延遲)
                    setTimeout(() => renderCategoryDetailCard(rowId), 500);
                })
                .withFailureHandler(err => {
                    clearStatus();
                    alert('更新失敗：' + (err && err.message || ''));
                })
                .setInvestValue(rowId, colKey, val);
        }

        function closeCategoryDetail() {
            const card = document.querySelector('#investDetailCardContainer .stk-details-card');
            if (card) {
                card.classList.remove('damping-open');
                card.classList.add('damping-close');
                setTimeout(() => {
                    const container = byId('investDetailCardContainer');
                    if (container) container.innerHTML = '';
                }, 400);
            }
        }

        // 輔助函式：針對篩選後的 rows 加總指定欄位
        function sumFiltered(rows, k) {
            return rows.reduce((s, r) => s + toNum(r[k]), 0);
        }

        // ===== Table Rendering =====
        function renderHead() {
            const thead = vs.thead; if (!thead) return;
            thead.innerHTML = `<tr>
        <th class="col-status"><span class="material-symbols-outlined" style="font-size:18px;">info</span></th>
        <th class="txt">項目</th>
        <th class="num col-fix-1">現值 (USD)</th>
        <th class="num col-fix-2">報價 (USD)</th>
        <th class="txt col-fix-3">損益 / ROI</th>
        <th class="num col-fix-4">利息 (USD)</th>
        <th class="txt col-fix-5">更新日</th>
      </tr>`;
        }

        function renderTable(rows) {
            viewRows = rows;
            if (vs.spacer) vs.spacer.style.height = (viewRows.length * vs.rowHeight) + 'px';
            if (vs.tbody) {
                vs.tbody.style.transform = 'translateY(0px)';
            }
            vs.lastRange = [-1, -1];
            renderVirtual();
        }

        function renderVirtual() {
            if (!vs.viewport || !vs.tbody || currentView !== 'details') return;
            const rows = viewRows;
            const top = vs.viewport.scrollTop;
            const h = vs.viewport.clientHeight;
            const start = Math.max(0, Math.floor(top / vs.rowHeight) - 5);
            const need = Math.ceil(h / vs.rowHeight) + 10;
            const end = Math.min(rows.length, start + need);
            if (vs.lastRange[0] === start && vs.lastRange[1] === end) return;
            vs.lastRange = [start, end];

            const slice = rows.slice(start, end);
            vs.tbody.style.transform = `translateY(${start * vs.rowHeight}px)`;
            vs.tbody.innerHTML = slice.map(r => {
                const uNum = isFinite(+r.U) ? normalizeU(r.U) : null;
                const rowNo = r.ROW || 0;

                const isActive = (r.AI === true || String(r.AI).trim().toUpperCase() === 'TRUE' || String(r.AI).trim() === '1');

                return `<tr data-row="${rowNo}" data-active="${isActive}">
          <td class="col-status"><span class="status-dot ${isActive ? 'active' : 'inactive'}"></span></td>
          <td class="txt">${esc(r.K || '-')}</td>
          <td class="num col-fix-1 mask-num" data-mask-str="＊＊＊">${esc(fmtMoney(r.N))}</td>
          <td class="num col-fix-2 cell-quote" data-row="${rowNo}">${esc(fmtMoney(r.QUOTE))}</td>
          <td class="txt col-fix-3">
            <div class="pnl-cell">
              <span class="num mask-num" data-mask-str="＊＊＊">${esc(fmtMoney(r.T))}</span>
              ${roiChipHTML(uNum)}
            </div>
          </td>
          <td class="num col-fix-4 cell-af" data-row="${rowNo}">${esc(fmtMoney(r.AF))}</td>
          <td class="txt col-fix-5">${esc(r.AH || '')}</td>
        </tr>`;
            }).join('');

            if (!slice.length) {
                vs.tbody.innerHTML = `<tr><td class="empty" colspan="6">目前沒有資料</td></tr>`;
            } else {
                vs.tbody.querySelectorAll('tr').forEach(tr => {
                    tr.onclick = (e) => {
                        if (e.target.closest('.cell-quote') || e.target.closest('.cell-af')) return;
                        const rowId = Number(tr.dataset.row);
                        if (currentCategory === '股票') {
                            if (window.App?.modules?.stk) App.modules.stk.renderDetailCard(rowId);
                        } else {
                            renderCategoryDetailCard(rowId);
                        }
                    };
                });
            }
        }

        // ===== Helpers =====
        function toNum(v) {
            if (v == null || v === '') return 0;
            const x = parseFloat(String(v).replace(/[^\d.-]/g, ''));
            return isFinite(x) ? x : 0;
        }
        function normalizeU(u) { const x = toNum(u); return (Math.abs(x) < 10) ? (x * 100) : x; }
        function esc(s) { return String(s ?? '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }
        function fmtMoney(v) { return isFinite(+v) ? (+v).toLocaleString('zh-Hant-TW', { minimumFractionDigits: 1 }) : '—'; }
        function byId(id) { return document.getElementById(id); }
        function qsa(sel) { return Array.from(document.querySelectorAll(sel)); }
        function setText(id, v, frac = 1) {
            const el = byId(id); if (!el) return;
            const val = (typeof v === 'number') ? v.toLocaleString('zh-Hant-TW', { minimumFractionDigits: frac, maximumFractionDigits: frac }) : (v || '—');
            el.textContent = val;
            el.classList.add('mask-num');
            el.dataset.maskStr = '＊＊＊';
        }
        function setPnlPill(id, v) {
            const el = byId(id); if (!el) return;
            el.innerHTML = roiChipHTML(v);
        }
        function roiChipHTML(v) {
            if (v == null || !isFinite(+v)) return '<span class="monolith-label mask-num" data-mask-str="＊＊＊">---</span>';
            const n = Number(v);
            const cls = n > 0 ? 'monolith-gain' : (n < 0 ? 'monolith-loss' : '');
            const sign = n > 0 ? '▲' : (n < 0 ? '▼' : '');
            return `<span class="monolith-label ${cls} mask-num" style="font-weight:700;" data-mask-str="＊＊＊">${sign} ${Math.abs(n).toFixed(1)}%</span>`;
        }
        function showStatus(msg) { const el = byId('investStatus'); if (el) el.textContent = msg; }
        function clearStatus() { showStatus(''); }
        function setBodyLoading(on) { if (on) byId('investBody').innerHTML = `<tr><td class="empty" colspan="6">載入中…</td></tr>`; }
        function failUI(msg) { byId('investBody').innerHTML = `<tr><td class="empty" colspan="6">發生錯誤：${esc(msg)}</td></tr>`; }

        function guessType(name) {
            if (/基金|fund|etf/i.test(name)) return '基金';
            if (/stock|股票|shrs|股份/i.test(name)) return '股票';
            if (/bond|債/i.test(name)) return '債券';
            if (/定存|cd\b/i.test(name)) return '定存';
            if (/loan|借款|貸款/i.test(name)) return 'Loan';
            if (/growin/i.test(name)) return 'Growin';
            return '其他';
        }

        // Event Bindings for Interaction
        function ensureAFBinding() {
            const tb = byId('investBody');
            if (tb && !tb._afBound) {
                tb.addEventListener('click', (e) => {
                    const td = e.target.closest('.cell-af');
                    if (td) {
                        // Re-use logic from ctbc if possible or implement editor
                        console.log('AF Clicked', td.dataset.row);
                    }
                });
                tb._afBound = true;
            }
        }
        function ensureRowClickBinding() {
            const tb = byId('investBody');
            if (tb && !tb._rowBound) {
                tb.addEventListener('click', (e) => {
                    const tr = e.target.closest('tr');
                    if (!tr || e.target.closest('.cell-af, .cell-quote')) return;

                    const name = tr.cells[0]?.textContent?.trim();
                    const mktMap = {
                        '貸款股票': 'Loan',
                        '中信股票': 'CTBC',
                        'Schwab美股': 'US',
                        'Growin美股': 'Growin'
                    };

                    if (mktMap[name]) {
                        const mkt = mktMap[name];
                        // 1. 設定 stk 模組的狀態
                        if (window.App?.modules?.stk) {
                            const stk = window.App.modules.stk;
                            // 注意：stk 可能還沒 init，所以我們直接設定一個全域 flag 或嘗試呼叫其內部方法
                            // 根據 stk_js.html，它有 state st.market
                            // 這裡我們假設 go('stk') 後會執行 init
                            localStorage.setItem('__stk_pending_market__', mkt);
                        }
                        // 2. 切換頁面
                        if (typeof go === 'function') go('stk');
                    }
                });
                tb._rowBound = true;
            }
        }

        // Final Init
        fetchData();
        return {
            init,
            showAddPrompt,
            closeCategoryDetail,
            renderCategoryDetailCard
        };
    })();

    App.pages = App.pages || {};
    App.pages.invest = {
        init: () => App.modules.invest.init(),
        refresh: () => App.modules.invest.init()
    };
</script>