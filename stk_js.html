<script>
window.App = window.App || {};
App.modules = App.modules || {};

App.modules.stk = (function(){
  // ===== Config（之後要擴充可編輯欄位就在這裡加）=====
  const EDITABLE_FIELDS = {
    E: { key:'E', label:'現價', type:'number', decimals:3, min:0 },
    R: { key:'R', label:'股息', type:'number', decimals:2, min:0 }
    // 之後若要指定更新日欄位，再加 updateDateCol:'<欄位字母>'
  };

  // ===== State =====
  let allRows = [];
  let viewRows = [];
  const vs = { rowH:44, viewport:null, spacer:null, thead:null, tbody:null, last:[-1,-1] };
  const st = { showOnlyOpen: true, expanded: new Set(), detailH: 120, totalCols: 7 };

  // ===== Init =====
  function init(){
    setupViewport();
    bindKPIFold();
    bindFilterToggle();
    bindGlobalEditModal();
    setBodyLoading(true);
    fetchData();
  }

  // ===== Data =====
  function fetchData(){
    // 支援 GAS 內嵌與 iframe 場景：嘗試從 window 與 parent 取得 google.script.run
    const run =
      (window.google && google.script && google.script.run) ? google.script.run :
      (window.parent && window.parent.google && window.parent.google.script && window.parent.google.script.run) ? window.parent.google.script.run :
      null;

    if (!run) {
      // 等待 Apps Script 物件注入（多給幾次 & 間隔拉長）
      if (!fetchData._try) fetchData._try = 0;
      if (fetchData._try++ < 80) { setTimeout(fetchData, 250); return; }
      failUI('載入失敗：找不到 Apps Script 執行環境（google.script.run）');
      return;
    }

    run
      .withSuccessHandler(rows=>{
        allRows = Array.isArray(rows) ? rows : [];
        applyFilter();
        renderKPI(viewRows);
        renderHead();
        renderTable(viewRows);
      })
      .withFailureHandler(err=> failUI(err && err.message || '讀取失敗'))
      .getSTKRows();
  }

  function applyFilter(){
    if (st.showOnlyOpen){
      viewRows = allRows.filter(r => !String(r.A||'').trim());
    }else{
      viewRows = allRows.slice();
    }
  }

  // ===== KPI =====
  function renderKPI(rows){
    const sum = k => rows.reduce((s,r)=> s + toNum(r[k]), 0);
    const totalMV   = sum('N'); // 市場價值
    const totalCost = sum('K'); // 成本
    const totalUPL  = sum('J'); // 未實現損益
    const totalPL   = sum('G'); // 損益(NT)

    // 加權 ROI（用 N 權重）
    let w=0, wU=0;
    rows.forEach(r=>{
      const n = toNum(r.N);
      const u = normalizePercent(r.H);
      if (n) { w += n; wU += (n * u); }
    });
    const roi = w ? (wU / w) : null;

    setNum('stkKpiMV',   totalMV,   1);
    setNum('stkKpiCost', totalCost, 1);
    setNum('stkKpiUPL',  totalUPL,  1);
    setNum('stkKpiPL',   totalPL,   1);
    setRoiPill(byId('stkKpiROI'), roi);
  }

  // ===== Head =====
  function renderHead(){
    if (!vs.thead) return;
    vs.thead.innerHTML = `<tr>
      <th class="txt">產品</th>               <!-- B -->
      <th class="num col-fix-1">股數</th>     <!-- C -->
      <th class="num col-fix-2">均價</th>     <!-- F -->
      <th class="num col-fix-3">現價</th>     <!-- E (editable) -->
      <th class="txt">未實現損益 / ROI</th>  <!-- J + H -->
      <th class="txt col-fix-4">市場</th>     <!-- T -->
      <th class="txt">狀態</th>               <!-- A -->
    </tr>`;
  }

  // ===== Body (virtual list) =====
  function renderTable(rows){
    // spacer 高度 = 主列高度 + 展開列高度
    const expandedCount = Array.from(st.expanded).filter(rowId => rows.find(r=> Number(r.ROW)===Number(rowId))).length;
    if (vs.spacer) vs.spacer.style.height = (rows.length * vs.rowH + expandedCount * st.detailH) + 'px';
    if (vs.tbody){ vs.tbody.style.transform = 'translateY(0px)'; vs.tbody.innerHTML=''; }
    vs.last = [-1,-1];
    renderVirtual();
  }
  function renderVirtual(){
    if (!vs.viewport || !vs.tbody) return;
    const rows = viewRows;
    const top  = vs.viewport.scrollTop;
    const h    = vs.viewport.clientHeight;

    const start= Math.max(0, Math.floor(top / vs.rowH) - 10);
    // 計算 start 之前的展開列數，修正 offset
    let expandedBefore = 0;
    for (let i=0; i<start; i++){
      const rowId = Number(rows[i]?.ROW||0);
      if (st.expanded.has(rowId)) expandedBefore++;
    }
    const offsetY = start * vs.rowH + expandedBefore * st.detailH;

    const need = Math.ceil(h / vs.rowH) + 20;
    const end  = Math.min(rows.length, start + need);
    if (vs.last[0]===start && vs.last[1]===end) return;
    vs.last = [start, end];

    const slice = rows.slice(start, end);
    vs.tbody.style.transform = `translateY(${offsetY}px)`;

    vs.tbody.innerHTML = slice.map(r=>{
      const rowId = Number(r.ROW||0);
      const roi   = normalizePercent(r.H);
      const upl   = fmtMoney(r.J);

      const main = `<tr class="stk-row" data-row="${rowId}">
        <td class="txt">
          <button class="row-toggle" data-row="${rowId}" title="展開/收合">▸</button>
          ${esc(r.B||'-')}
        </td>
        <td class="num col-fix-1">${fmtInt(r.C)}</td>
        <td class="num col-fix-2">${fmtMoney(r.F)}</td>
        <td class="num col-fix-3">
          <button class="cell-edit" data-col="E" title="點擊編輯現價">${fmtMoney(r.E)}</button>
        </td>
        <td class="txt">
          <div class="pnl-cell">
            <span class="num">${upl}</span>
            ${roiPillHTML(roi)}
          </div>
        </td>
        <td class="txt col-fix-4">${esc(r.T||'')}</td>
        <td class="txt">${String(r.A||'').trim()? '已賣出':'—'}</td>
      </tr>`;

      if (!st.expanded.has(rowId)) return main;

      const detail = `<tr class="stk-detail" data-row="${rowId}">
        <td class="txt" colspan="${st.totalCols}">
          <div class="detail-grid">
            <div><b>市場價值(N)</b>：${fmtMoney(r.N)}</div>
            <div><b>成本(K)</b>：${fmtMoney(r.K)}</div>
            <div><b>股息(R)</b>：<button class="cell-edit" data-col="R" title="點擊編輯股息">${fmtMoney(r.R)}</button></div>
            <div><b>ROI(H)</b>：${roiPillHTML(roi)}</div>
            <div><b>買日(L)</b>：${fmtDate(r.L)}</div>
            <div><b>賣日(M)</b>：${fmtDate(r.M)}</div>
            <div><b>手續+稅(Q)</b>：${fmtMoney(r.Q)}</div>
            <div><b>單位(U)</b>：${esc(r.U||'')}</div>
          </div>
        </td>
      </tr>`;
      return main + detail;
    }).join('');

    // 綁定 slice 內事件
    vs.tbody.querySelectorAll('.cell-edit').forEach(btn=>{
      btn.addEventListener('click', onEditCellClick);
    });
    vs.tbody.querySelectorAll('.row-toggle').forEach(btn=>{
      btn.addEventListener('click', onToggleRow);
    });

    if (!slice.length){
      vs.tbody.style.transform = 'translateY(0px)';
      vs.tbody.innerHTML = `<tr><td class="empty" colspan="${st.totalCols}">目前沒有資料</td></tr>`;
    }
  }

  function onToggleRow(e){
    const rowId = Number(e.currentTarget.dataset.row||0);
    if (!rowId) return;
    if (st.expanded.has(rowId)) st.expanded.delete(rowId);
    else st.expanded.add(rowId);
    renderTable(viewRows);
  }

  function bindFilterToggle(){
    const btn = byId('stkFilterToggle');
    if (!btn) return;
    const syncLabel = ()=> btn.textContent = st.showOnlyOpen ? '只看未賣出：開' : '只看未賣出：關';
    syncLabel();
    btn.onclick = ()=>{
      st.showOnlyOpen = !st.showOnlyOpen;
      st.expanded.clear();
      applyFilter();
      renderKPI(viewRows);
      renderHead();
      renderTable(viewRows);
      syncLabel();
    };
  }

  // ===== Edit modal =====
  function bindGlobalEditModal(){
    const dlg = byId('stkEditDlg');
    const form= byId('stkEditForm');
    const input= byId('stkEditInput');
    const ok  = byId('stkEditOk');
    const cancelBtn = byId('stkEditCancel');
    const closeBtn  = byId('stkEditClose');

    if (!dlg || !form) return;

    const close = ()=> closeEdit();
    if (cancelBtn) cancelBtn.onclick = close;
    if (closeBtn)  closeBtn.onclick  = close;
    ok.onclick = (e)=>{ e.preventDefault(); submitEdit(); };
    form.onsubmit = (e)=>{ e.preventDefault(); submitEdit(); };
    input.onkeydown = (e)=>{ if (e.key === 'Escape') closeEdit(); };
  }

  function onEditCellClick(e){
    const btn = e.currentTarget;
    const tr  = btn.closest('tr');
    const row = Number(tr && tr.dataset.row || 0);
    const col = String(btn.dataset.col||'').toUpperCase();

    const field = EDITABLE_FIELDS[col];
    if (!row || !field) return;

    const r = allRows.find(x => Number(x.ROW)===row);
    const current = r ? r[col] : '';

    openEdit({
      row, col,
      title: field.label,
      type: field.type,
      value: toNum(current),
      decimals: field.decimals ?? 2,
      min: field.min ?? null,
      updateDateCol: field.updateDateCol || null
    });
  }

  function openEdit(meta){
    const dlg = byId('stkEditDlg');
    if (!dlg) return;
    dlg.dataset.row = meta.row;
    dlg.dataset.col = meta.col;
    dlg.dataset.decimals = meta.decimals;
    dlg.dataset.min = (meta.min==null ? '' : String(meta.min));
    dlg.dataset.updateDateCol = meta.updateDateCol || '';
    byId('stkEditTitle').textContent = `編輯：${meta.title}`;
    const input = byId('stkEditInput');
    input.type = (meta.type==='number' ? 'number' : 'text');
    input.step = (meta.type==='number' ? 'any' : undefined);
    input.value = (meta.value ?? '');
    dlg.style.display = 'block';
    setTimeout(()=> input.focus(), 0);
  }
  function closeEdit(){
    const dlg = byId('stkEditDlg');
    if (!dlg) return;
    dlg.style.display = 'none';
    dlg.dataset.row = dlg.dataset.col = dlg.dataset.decimals = dlg.dataset.min = dlg.dataset.updateDateCol = '';
  }

  function submitEdit(){
    const dlg = byId('stkEditDlg');
    if (!dlg) return;
    const row = Number(dlg.dataset.row||0);
    const col = String(dlg.dataset.col||'');
    const decimals = Number(dlg.dataset.decimals||2);
    const min = (dlg.dataset.min===''? null : Number(dlg.dataset.min));
    const updateDateCol = dlg.dataset.updateDateCol || '';
    const input = byId('stkEditInput');
    let val = input.value;

    if (val==='' || val==null){
      alert('請輸入數值');
      return;
    }
    let num = toNum(val);
    if (min!=null && num < min){
      alert(`數值不可小於 ${min}`);
      return;
    }

    // 後端 API：setSTKValue(row, col, value, updateDateCol)
    toggleBusy(true);
    google.script.run
      .withSuccessHandler(ok=>{
        toggleBusy(false);
        closeEdit();
        // 更新前端快取
        const r = allRows.find(x=> Number(x.ROW)===row);
        if (r){ r[col] = round(num, decimals); if (updateDateCol) r[updateDateCol] = todayISO(); }
        // 重新算 KPI & 局部重繪：這裡偷懶直接重繪虛擬片段
        renderKPI(viewRows);
        renderVirtual();
      })
      .withFailureHandler(err=>{
        toggleBusy(false);
        alert('寫入失敗：' + (err && err.message || ''));
      })
      .setSTKValue(row, col, round(num, decimals), updateDateCol || null);
  }

  // ===== UI helpers =====
  function setupViewport(){
    vs.viewport = byId('stkViewport');
    vs.spacer   = byId('stkSpacer');
    vs.thead    = byId('stkHead');
    vs.tbody    = byId('stkBody');
    if (!vs.viewport) return;
    let raf=null;
    vs.viewport.addEventListener('scroll', ()=>{
      if (raf) return;
      raf = requestAnimationFrame(()=>{ raf=null; renderVirtual(); });
    });
  }
  function bindKPIFold(){
    const btn = byId('stkKpiToggle');
    const wrap= byId('stkKPI');
    if (btn && wrap){
      btn.onclick = ()=>{
        const on = wrap.dataset.collapsed === '1' ? '0' : '1';
        wrap.dataset.collapsed = on;
        btn.textContent = (on==='1') ? '展開統計' : '收合統計';
      };
    }
  }

  // ===== Generic helpers =====
  function byId(id){ return document.getElementById(id); }
  function esc(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m])); }
  function toNum(v){
    if (v == null || v === '') return 0;
    if (typeof v === 'number') return isFinite(v) ? v : 0;
    const s = String(v).replace(/[%\uFFE5\u00A5$￥]/g,'').replace(/[\s,]/g,'');
    const x = parseFloat(s);
    return isFinite(x) ? x : 0;
  }
  function round(n, dec=2){ const f = Math.pow(10, dec); return Math.round(n * f) / f; }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function normalizePercent(u){
    const n = Number(u||0);
    if (!isFinite(n)) return null;
    return (Math.abs(n) <= 1) ? (n*100) : n; // 0.12 => 12%
  }
  function fmtMoney(v){ return isFinite(+v) ? (+v).toLocaleString('zh-Hant-TW',{minimumFractionDigits:1, maximumFractionDigits:1}) : '—'; }
  function fmtInt(v){ return isFinite(+v) ? Math.round(+v).toLocaleString('zh-Hant-TW') : '—'; }
  function fmtDate(v){
    try{
      if (v instanceof Date) {
        return new Date(v.getTime() - v.getTimezoneOffset()*60000).toISOString().slice(0,10);
      }
      const s = String(v||'').trim();
      if (!s) return '';
      const d = new Date(s);
      return isNaN(d) ? s : d.toISOString().slice(0,10);
    }catch(_){ return String(v||''); }
  }
  function setNum(id, v, frac=1){
    const el = byId(id); if (!el) return;
    const n = Number(v);
    el.textContent = isFinite(n) ? n.toLocaleString('zh-Hant-TW',{minimumFractionDigits:frac, maximumFractionDigits:frac}) : '—';
    if (!el.classList.contains('mask-num')) el.classList.add('mask-num');
    if (!el.dataset.maskStr) el.dataset.maskStr = '＊＊＊';
  }
  function roiPillHTML(v){
    if (v == null || !isFinite(+v)) return '<span class="roi-badge zero">—</span>';
    const n = Number(v);
    const cls  = n>0 ? 'pos' : (n<0 ? 'neg' : 'zero');
    const sign = n>0 ? '+' : (n<0 ? '−' : '');
    const s = Math.abs(n).toLocaleString('zh-Hant-TW',{minimumFractionDigits:1, maximumFractionDigits:1});
    return `<span class="roi-badge ${cls}">${sign}${s}%</span>`;
  }
  function setRoiPill(el, v){ if (el) el.innerHTML = roiPillHTML(v); }
  function setBodyLoading(on){
    const tb = byId('stkBody'); if (!tb) return;
    tb.innerHTML = on ? `<tr><td class="empty" colspan="${st.totalCols}">載入中…</td></tr>` : '';
  }
  function failUI(msg){
    const tb = byId('stkBody'); if (tb) tb.innerHTML = `<tr><td class="empty" colspan="${st.totalCols}">發生錯誤：${esc(msg||'')}</td></tr>`;
  }
  function toggleBusy(on){
    const ok = byId('stkEditOk');
    const txt= byId('stkEditOkTxt');
    const sp = byId('stkEditOkSpin');
    if (!ok) return;
    ok.disabled = !!on;
    if (txt && sp){
      txt.style.display = on ? 'none' : 'inline';
      sp.style.display  = on ? 'inline-block' : 'none';
    }
  }

  return { init };
})();

;(function autoInitSTK(){
  try{
    const start = ()=> { if (App && App.modules && App.modules.stk && typeof App.modules.stk.init==='function') App.modules.stk.init(); };
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start);
    else start();
  }catch(_){}
})();
</script>