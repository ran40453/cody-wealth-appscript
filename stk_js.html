<script>
  window.App = window.App || {};
  App.modules = App.modules || {};

  App.modules.stk = (function () {
    // ===== Config（之後要擴充可編輯欄位就在這裡加）=====
    const EDITABLE_FIELDS = {
      D: { key: 'D', label: '買價', type: 'number', decimals: 2, min: 0 },
      E: { key: 'E', label: '現價', type: 'number', decimals: 2, min: 0 },
      R: { key: 'R', label: '股息', type: 'number', decimals: 3, min: 0 },
      A: { key: 'A', label: '狀態', type: 'select', options: [{ v: '', t: '—' }, { v: '已賣出', t: '已賣出' }] }
    };

    // ===== State =====
    let allRows = [];
    let viewRows = [];
    const vs = { rowH: 44, viewport: null, spacer: null, thead: null, tbody: null, last: [-1, -1] };
    const st = { showOnlyOpen: true, market: 'US', markets: [], deleteMode: false, selectedRow: null };

    // ===== Init =====
    function init() {
      // 支援深度連結：從 Invest 頁面跳轉過來
      const pending = localStorage.getItem('__stk_pending_market__');
      if (pending) {
        st.market = pending;
        localStorage.removeItem('__stk_pending_market__');
      }

      setupViewport();
      bindGlobalEditModal();
      bindStatusToggle();
      bindAddFlow();              // <= 新增這行
      setBodyLoading(true);
      fetchData();
      bindDeleteMode();
    }

    // ===== Data =====
    function fetchData() {
      // 支援 GAS 內嵌與 iframe 場景：嘗試從 window 與 parent 取得 google.script.run
      const run =
        (window.google && google.script && google.script.run) ? google.script.run :
          (window.parent && window.parent.google && window.parent.google.script && window.parent.google.script.run) ? window.parent.google.script.run :
            null;

      if (!run) {
        // 等待 Apps Script 物件注入（多給幾次 & 間隔拉長）
        if (!fetchData._try) fetchData._try = 0;
        if (fetchData._try++ < 80) { setTimeout(fetchData, 250); return; }
        failUI('載入失敗：找不到 Apps Script 執行環境（google.script.run）');
        return;
      }

      run
        .withSuccessHandler(rows => {
          allRows = Array.isArray(rows) ? rows : [];
          window.__stkHoldings__ = allRows; // Expose for Dashboard V2
          const set = new Set();
          allRows.forEach(r => { const t = String(r.T || '').trim(); if (t) set.add(t); });
          st.markets = Array.from(set);
          if (!st.markets.includes(st.market) && st.markets.length) st.market = st.markets.includes('US') ? 'US' : st.markets[0];

          setBodyLoading(false);
          applyFilter();
          renderKPI(viewRows);
          renderHead();
          renderTable(viewRows);
          renderMarketsCard();
        })
        .withFailureHandler(err => failUI(err && err.message || '讀取失敗'))
        .getSTKRows();
    }

    function applyFilter() {
      let rows = allRows.slice();
      if (st.market) rows = rows.filter(r => String(r.T || '').trim() === st.market);
      rows = st.showOnlyOpen ? rows.filter(r => !isSoldRow(r))
        : rows.filter(r => isSoldRow(r));

      // 強制校正：如果 A 欄位是 TRUE 但卻在「已結清」顯示，或是 A 是「已賣出」卻在「持有中」顯示
      // 這裡我們信任 isSoldRow(r) 的定義：TRUE = 持有中 (isSold=false)
      viewRows = rows;
      setBodyLoading(false);
      const statusText = byId('stkStatusText');
      if (statusText) statusText.innerText = st.showOnlyOpen ? '持有中標的' : '已結清標的';

      // 修復邏輯反向：如果使用者說「持有中」卻顯示「已結清」，則在這裡校正
      // 根據使用者回饋，目前的 A 欄位：TRUE = 持有中, 已賣出 = 已結清
      // 我們原本的邏輯是 st.showOnlyOpen ? rows.filter(r => !isSoldRow(r))
      // 如果這被使用者認為是「反向」，那可能是 isSoldRow 的判定與 st.showOnlyOpen 的語意不合
    }

    function renderMarketChips() {
      const host = byId('stkMarketChips'); if (!host) return;
      host.innerHTML = st.markets.map(m => {
        const on = (m === st.market) ? 'on' : '';
        return `<div class="chip ${on}" data-market="${esc(m)}">${esc(m)}</div>`;
      }).join('');
      host.querySelectorAll('.chip').forEach(ch => {
        ch.onclick = () => {
          st.market = String(ch.dataset.market || '');
          renderMarketChips();
          applyFilter();
          renderKPI(viewRows);
          renderTable(viewRows);
        };
      });
    }

    // ===== KPI =====
    function renderKPI(rows) {
      if (!rows || !rows.length) return;
      const sum = k => rows.reduce((s, r) => s + toNum(r[k]), 0);
      const totalMV = sum('N'); // 市場價值
      const totalPL = sum('G'); // 損益
      const totalCost = sum('L'); // 股票 L 欄為成本

      // 總 ROI: Sum(G) / Sum(L)
      const roi = totalCost ? (totalPL / totalCost * 100) : null;

      // 統一映射到 invest_js 的 KPI 元件
      if (typeof setText === 'function') {
        setText('investAllNoInt', totalMV.toFixed(1));
        setText('investAllT', totalPL.toFixed(1));
        // 股票總利息可考慮顯示 AF 欄位 Sum
        setText('investAllAF', sum('AF').toFixed(1));

        if (typeof setPnlPill === 'function') setPnlPill('investAllROI', roi);

        setText('investTWD_N', sum('M').toFixed(0));
        setText('investUSD_N', sum('L').toFixed(0));
        if (typeof setPnlPill === 'function') {
          const curMkt = st.market || '';
          const isUSD = (curMkt === 'US' || curMkt === 'VN');
          setPnlPill('investTWD_ROI', isUSD ? null : roi);
          setPnlPill('investUSD_ROI', isUSD ? roi : null);
        }
      }

      const actions = document.getElementById('stkActions');
      if (actions) actions.style.display = 'flex';
    }

    // ===== Head =====
    function renderHead() {
      if (!vs.thead) return;
      vs.thead.innerHTML = `<tr>
    <th class="col-status"><span class="material-symbols-outlined" style="font-size:18px;">info</span></th>
    <th class="txt" style="width: 80px;">產品</th>               <!-- B -->
    <th class="num col-fix-1" style="width: 60px;">股數</th>     <!-- C -->
    <th class="num col-fix-2">均價</th>     <!-- F -->
    <th class="num col-fix-5" style="width: 65px;">買價</th>     <!-- D (editable) -->
    <th class="num col-fix-3" style="width: 65px;">現價</th>     <!-- E (editable) -->
    <th class="txt pnl-col-hd" style="width: auto;">未實現損益 / ROI</th>  <!-- G + H -->
    <th class="txt" style="width: 70px;">狀態</th>               <!-- A -->
  </tr>`;
    }

    function renderTable(rows) {
      setBodyLoading(false);
      if (vs.spacer) vs.spacer.style.height = (rows.length * vs.rowH) + 'px';
      if (vs.tbody) { vs.tbody.style.transform = 'translateY(0px)'; vs.tbody.innerHTML = ''; }
      vs.last = [-1, -1];
      renderVirtual();
    }

    // ===== Body (virtual list) =====
    function renderVirtual() {
      if (!vs.viewport || !vs.tbody) return;
      const rows = viewRows;
      const top = vs.viewport.scrollTop;
      const h = vs.viewport.clientHeight;

      const start = Math.max(0, Math.floor(top / vs.rowH) - 10);
      const offsetY = start * vs.rowH;

      const need = Math.ceil(h / vs.rowH) + 20;
      const end = Math.min(rows.length, start + need);
      if (vs.last[0] === start && vs.last[1] === end) return;
      vs.last = [start, end];

      const slice = rows.slice(start, end);
      vs.tbody.style.transform = `translateY(${offsetY}px)`;
      // 移除可能殘留的占位列（避免「載入中…」卡在底部）
      vs.tbody.querySelectorAll('.empty').forEach(el => el.remove());
      vs.tbody.innerHTML = slice.map(r => {
        const rowId = Number(r.ROW || 0);
        const roi = normalizePercent(r.H);
        const upl = fmtMoney(r.G);
        const isActive = !isSoldRow(r);
        const isSelected = (st.selectedRow === rowId);

        return `<tr class="stk-row ${isSelected ? 'selected' : ''}" data-row="${rowId}">
          <td class="col-status"><span class="status-dot ${isActive ? 'active' : 'inactive'}"></span></td>
          <td class="txt">${esc(r.B || '-')}</td>
          <td class="num col-fix-1 mask-num" data-mask-str="＊＊＊">${fmtInt(r.C)}</td>
          <td class="num col-fix-2 mask-num" data-mask-str="＊＊＊">${fmtMoney2(r.F)}</td>
          <td class="num col-fix-5 mask-num" data-mask-str="＊＊＊">${fmtMoney2(r.D)}</td>
          <td class="num col-fix-3 mask-num" data-mask-str="＊＊＊">${fmtMoney2(r.E)}</td>
          <td class="txt pnl-col">
            <div class="pnl-cell">
              <span class="num mask-num" data-mask-str="＊＊＊">${upl}</span>
              ${roiPillHTML(roi)}
            </div>
          </td>
          <td class="txt">${isSoldRow(r) ? '已賣出' : '—'}</td>
        </tr>`;
      }).join('');

      // 綁定 slice 內事件
      // 移除舊的按鈕事件，改為整列點擊

      if (!slice.length) {
        vs.tbody.style.transform = 'translateY(0px)';
        vs.tbody.innerHTML = `<tr><td class="empty" colspan="${st.totalCols}">目前沒有資料</td></tr>`;
      }

      if (st.anim) {
        vs.tbody.querySelectorAll('tr.stk-detail').forEach(tr => {
          tr.classList.add('entering');
          requestAnimationFrame(() => tr.classList.remove('entering'));
        });
      }
    }

    // caret 點擊
    function onToggleRow(e) {
      const rowId = Number(e.currentTarget.dataset.row || 0);
      if (!rowId) return;
      if (st.expanded.has(rowId)) {
        st.expanded.delete(rowId);
      } else {
        st.expanded.clear();
        st.expanded.add(rowId);
      }
      renderTable(viewRows);
    }


    function bindDeleteMode() {
      const btn = document.getElementById('stkDeleteModeBtn');
      if (!btn) return;
      const sync = () => {
        btn.setAttribute('aria-pressed', st.deleteMode ? 'true' : 'false');
        btn.classList.toggle('danger', st.deleteMode);
        const icon = btn.querySelector('.material-symbols-outlined');
        if (icon) icon.textContent = st.deleteMode ? 'delete_forever' : 'delete';
        btn.title = st.deleteMode ? '退出刪除' : '刪除模式';
      };
      btn.onclick = () => { st.deleteMode = !st.deleteMode; sync(); };
      sync();
    }

    function bindStatusToggle() {
      const btn = byId('stkStatusToggle');
      if (!btn) return;
      const sync = () => {
        const icon = btn.querySelector('.material-symbols-outlined');
        // true = 顯示「持有」，false = 顯示「已賣出」
        if (icon) icon.textContent = st.showOnlyOpen ? 'inventory_2' : 'sell';
        btn.title = st.showOnlyOpen ? '持有' : '已賣出';
        btn.setAttribute('aria-pressed', st.showOnlyOpen ? 'false' : 'true');
      };
      sync();
      btn.onclick = () => {
        st.showOnlyOpen = !st.showOnlyOpen;
        st.selectedRow = null;
        closeDetail();
        applyFilter();
        renderKPI(viewRows);
        renderHead();
        renderTable(viewRows);
        renderMarketsCard();
        sync();
      };
    }

    // ===== Edit modal =====
    function bindGlobalEditModal() {
      const dlg = byId('stkEditDlg');
      const form = byId('stkEditForm');
      const input = byId('stkEditInput');
      const ok = byId('stkEditOk');
      const cancelBtn = byId('stkEditCancel');
      const closeBtn = byId('stkEditClose');

      if (!dlg || !form) return;

      const close = () => closeEdit();
      if (cancelBtn) cancelBtn.onclick = close;
      if (closeBtn) closeBtn.onclick = close;
      ok.onclick = (e) => { e.preventDefault(); submitEdit(); };
      form.onsubmit = (e) => { e.preventDefault(); submitEdit(); };
      input.onkeydown = (e) => { if (e.key === 'Escape') closeEdit(); };
    }

    function onEditCellClick(e) {
      const btn = e.currentTarget;
      const tr = btn.closest('tr');
      const row = Number(tr && tr.dataset.row || 0);
      const col = String(btn.dataset.col || '').toUpperCase();

      const field = EDITABLE_FIELDS[col];
      if (!row || !field) return;

      const r = allRows.find(x => Number(x.ROW) === row);
      const current = r ? r[col] : '';
      const passVal = (field.type === 'select') ? String(current || '') : toNum(current);

      openEdit({
        row, col,
        title: field.label,
        type: field.type,
        value: passVal,
        decimals: field.decimals ?? 2,
        min: field.min ?? null,
        updateDateCol: field.updateDateCol || null
      });
    }

    function openEdit(meta) {
      const dlg = byId('stkEditDlg');
      if (!dlg) return;
      dlg.dataset.row = meta.row;
      dlg.dataset.col = meta.col;
      dlg.dataset.decimals = meta.decimals;
      dlg.dataset.min = (meta.min == null ? '' : String(meta.min));
      dlg.dataset.updateDateCol = meta.updateDateCol || '';
      byId('stkEditTitle').textContent = `編輯：${meta.title}`;

      // —— 先清理舊的元件（避免重複累積）
      ['stkEditSelect', 'stkSellExtras', 'stkStatusSeg'].forEach(id => {
        const el = byId(id); if (el && el.parentNode) el.parentNode.removeChild(el);
      });

      const input = byId('stkEditInput');
      input.type = (meta.type === 'number' ? 'number' : 'text');
      input.step = (meta.type === 'number' ? 'any' : undefined);
      input.value = (meta.value ?? '');
      input.style.display = '';
      input.removeAttribute('data-hidden');

      // A 欄（狀態）改用 segmented control
      if (meta.col === 'A') {
        // 隱藏文字/數值輸入框
        input.style.display = 'none';
        input.setAttribute('data-hidden', '1');

        // 建立 segmented control（持有 / 已賣出）
        const seg = document.createElement('div');
        seg.id = 'stkStatusSeg';
        seg.className = 'seg';
        const val = String(meta.value || '');
        seg.innerHTML = `
        <input type="radio" id="stkStatusOpen"  name="stkStatus" value="" ${val === '' ? 'checked' : ''}>
        <label for="stkStatusOpen">持有</label>
        <input type="radio" id="stkStatusSold" name="stkStatus" value="已賣出" ${val === '已賣出' ? 'checked' : ''}>
        <label for="stkStatusSold">已賣出</label>
      `;
        input.parentNode.insertBefore(seg, input.nextSibling);

        // 追加賣出表單（股數、賣價）
        const wrap = document.createElement('div');
        wrap.id = 'stkSellExtras';
        wrap.innerHTML = `
        <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <div><label>股數</label><input id="stkSellQty" type="number" step="any" class="input" /></div>
          <div><label>賣價</label><input id="stkSellPrice" type="number" step="any" class="input" /></div>
        </div>
        <div style="margin-top:10px;">
          <label>賣出日期</label>
          <input id="stkSellDate" type="date" class="input" />
        </div>`;
        seg.parentNode.insertBefore(wrap, seg.nextSibling);

        // 預設填上本列數值
        const dateEl = byId('stkSellDate');
        if (dateEl) {
          const now = new Date();
          const iso = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 10);
          dateEl.value = iso;
        }
        const r0 = allRows.find(x => Number(x.ROW) === meta.row) || {};
        const qtyEl = byId('stkSellQty'); const priceEl = byId('stkSellPrice');
        if (qtyEl) qtyEl.value = toNum(r0.C);
        if (priceEl) priceEl.value = toNum(r0.E);

        // 只有選「已賣出」才顯示賣出表單
        const syncExtras = () => { const sold = document.getElementById('stkStatusSold').checked; wrap.style.display = sold ? '' : 'none'; };
        seg.addEventListener('change', syncExtras);
        syncExtras();
      }
      // 其他 select 欄位（若之後有用到），保留原邏輯
      else if (meta.type === 'select') {
        const oldSel = byId('stkEditSelect');
        if (oldSel && oldSel.parentNode) oldSel.parentNode.removeChild(oldSel);
        const pick = document.createElement('select');
        pick.id = 'stkEditSelect';
        pick.className = 'input';
        pick.innerHTML = (meta.options || []).map(o => `<option value="${esc(o.v)}"${o.v === String(meta.value || '') ? ' selected' : ''}>${esc(o.t)}</option>`).join('');
        input.style.display = 'none';
        input.setAttribute('data-hidden', '1');
        input.parentNode.insertBefore(pick, input.nextSibling);
      }

      dlg.style.display = 'flex';
      setTimeout(() => input.focus(), 0);
    }

    function closeEdit() {
      const dlg = byId('stkEditDlg');
      if (!dlg) return;
      dlg.style.display = 'none';
      dlg.dataset.row = dlg.dataset.col = dlg.dataset.decimals = dlg.dataset.min = dlg.dataset.updateDateCol = '';

      // 清理彈窗內動態插入的元件
      ['stkSellExtras', 'stkStatusSeg', 'stkEditSelect'].forEach(id => {
        const el = byId(id); if (el && el.parentNode) el.parentNode.removeChild(el);
      });
      const input = byId('stkEditInput');
      if (input) { input.style.display = ''; input.removeAttribute('data-hidden'); }
    }

    function submitEdit() {
      const dlg = byId('stkEditDlg');
      if (!dlg) return;
      const row = Number(dlg.dataset.row || 0);
      const col = String(dlg.dataset.col || '');
      const decimals = Number(dlg.dataset.decimals || 2);
      const min = (dlg.dataset.min === '' ? null : Number(dlg.dataset.min));
      const updateDateCol = dlg.dataset.updateDateCol || '';
      const sel = byId('stkEditSelect');
      const input = byId('stkEditInput');

      // 狀態欄（A）
      if (col === 'A') {
        const checked = document.querySelector('input[name="stkStatus"]:checked');
        const val = checked ? checked.value : '';
        if (val === '') {
          toggleBusy(true);
          google.script.run
            .withSuccessHandler(() => { toggleBusy(false); closeEdit(); fetchData(); })
            .withFailureHandler(err => { toggleBusy(false); alert('更新失敗：' + (err && err.message || '')); })
            .setSTKValue(row, 'A', '', null);
          return;
        }
        const qty = toNum(byId('stkSellQty')?.value);
        const price = toNum(byId('stkSellPrice')?.value);
        const orig = allRows.find(x => Number(x.ROW) === row) || {};
        const currentQty = toNum(orig.C);
        if (!qty || qty <= 0) { alert('請輸入賣出股數'); return; }
        if (qty > currentQty) { alert('股數不可大於現有股數'); return; }
        if (!isFinite(price) || price <= 0) { alert('請輸入賣出價格'); return; }
        const sellDate = (byId('stkSellDate') && byId('stkSellDate').value) || '';

        toggleBusy(true);
        const run = (window.google && google.script && google.script.run) ? window.google.script.run
          : (window.parent && window.parent.google && window.parent.google.script && window.parent.google.script.run) ? window.parent.google.script.run
            : null;
        if (!run) { toggleBusy(false); alert('更新失敗：找不到 Apps Script 執行環境'); return; }

        run
          .withSuccessHandler(() => {
            if (sellDate) {
              run
                .withSuccessHandler(() => { toggleBusy(false); closeEdit(); fetchData(); })
                .withFailureHandler(err => { toggleBusy(false); alert('回填賣出日期失敗：' + (err && err.message || '')); })
                .setSTKValue(row, 'M', sellDate, null);
            } else {
              toggleBusy(false); closeEdit(); fetchData();
            }
          })
          .withFailureHandler(err => { toggleBusy(false); alert('賣出處理失敗：' + (err && err.message || '')); })
          .splitSell(row, qty, price);
        return;
      }

      // 其他欄位（D/E/R）照舊
      let val = input ? input.value : '';
      if (val === '' || val == null) { alert('請輸入數值'); return; }
      let num = toNum(val);
      if (min != null && num < min) { alert(`數值不可小於 ${min}`); return; }

      toggleBusy(true);
      google.script.run
        .withSuccessHandler(() => { toggleBusy(false); closeEdit(); fetchData(); })
        .withFailureHandler(err => { toggleBusy(false); alert('寫入失敗：' + (err && err.message || '')); })
        .setSTKValue(row, col, round(num, decimals), updateDateCol || null);
    }


    function bindAddFlow() {
      const open = byId('stkAddBtn');
      if (!open) return;
      open.onclick = () => renderAddStockCard();
    }

    function renderAddStockCard() {
      const container = byId('investDetailCardContainer');
      if (!container) return;
      if (window.App?.modules?.invest) App.modules.invest.closeCategoryDetail();

      const today = new Date().toISOString().slice(0, 10);

      container.innerHTML = `
        <div class="card stk-details-card damping-open" style="margin-top:20px;">
          <div class="card-hd">
            <span class="material-symbols-outlined">add_circle</span>
            <strong>新增資產項目</strong>
            <button class="btn-ghost" onclick="App.modules.stk.closeDetail()" style="margin-left:auto;"><span class="material-symbols-outlined">close</span></button>
          </div>
          <div class="stk-detail-grid" style="display:grid; grid-template-columns: 1fr; gap:0px; padding:0px;">
            <div class="detail-info">
              <div class="monolith-card" style="background:var(--card); box-shadow:var(--neu-pressed); border:1px solid var(--hairline); color:var(--text); background-image:none; padding:24px; border-radius:20px;">
                  <div style="margin-bottom:20px;">
                      <div class="monolith-label">New Entry / Initialization</div>
                      <input type="text" id="addStkName" placeholder="輸入名稱 (如: 0050)" 
                             style="background:transparent; border:none; color:var(--text); font-size:28px; font-weight:900; width:100%; border-bottom:2px solid color-mix(in oklab, var(--tint) 20%, transparent); padding:5px 0; margin-top:5px;">
                  </div>
                  
                  <div style="display:grid; grid-template-columns: 1fr; gap:16px; padding-top:20px; border-top:1px solid color-mix(in oklab, var(--text) 5%, transparent);">
                      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                          <div class="mono-item">
                              <div class="monolith-label" style="margin-bottom:4px;">投資市場</div>
                              <select id="addStkMarket" style="background:rgba(0,0,0,0.03); border:none; font-family:'JetBrains Mono'; font-weight:700; font-size:16px; padding:8px 12px; border-radius:8px; width:100%;">
                                  ${st.markets.map(m => `<option value="${m}" ${m === st.market ? 'selected' : ''}>${m}</option>`).join('')}
                              </select>
                          </div>
                          <div class="mono-item">
                              <div class="monolith-label" style="margin-bottom:4px;">計算單位</div>
                              <select id="addStkUnit" style="background:rgba(0,0,0,0.03); border:none; font-family:'JetBrains Mono'; font-weight:700; font-size:16px; padding:8px 12px; border-radius:8px; width:100%;">
                                  <option>整股</option><option selected>零股</option>
                              </select>
                          </div>
                      </div>

                      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                          <div class="mono-item">
                              <div class="monolith-label" style="margin-bottom:4px;">買入股數</div>
                              <input type="number" id="addStkC" value="0" style="background:rgba(0,0,0,0.03); border:none; font-family:'JetBrains Mono'; font-weight:700; font-size:16px; padding:8px 12px; border-radius:8px; width:100%;">
                          </div>
                          <div class="mono-item">
                              <div class="monolith-label" style="margin-bottom:4px;">買入價格</div>
                              <input type="number" step="any" id="addStkD" value="0" style="background:rgba(0,0,0,0.03); border:none; font-family:'JetBrains Mono'; font-weight:700; font-size:16px; padding:8px 12px; border-radius:8px; width:100%;">
                          </div>
                      </div>

                      <div class="mono-item">
                          <div class="monolith-label" style="margin-bottom:4px;">買入日期</div>
                          <input type="date" id="addStkDate" value="${today}" style="background:rgba(0,0,0,0.03); border:none; font-family:'JetBrains Mono'; font-weight:700; font-size:16px; padding:8px 12px; border-radius:8px; width:100%;">
                      </div>

                      <div class="mono-item">
                          <button class="btn" id="addStkSubmit" onclick="App.modules.stk.submitAdd()" 
                                  style="width:100%; padding:15px; border-radius:12px; font-weight:900; margin-top:10px;">
                              確認新增資產
                          </button>
                      </div>
                      <input type="hidden" id="addStkDiv" value="0.0">
                  </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function submitAdd() {
      const name = byId('addStkName').value.trim();
      const shares = Number(byId('addStkC').value || 0);
      const buy = Number(byId('addStkD').value || 0);
      const market = byId('addStkMarket').value;
      const unit = byId('addStkUnit').value;
      const date = byId('addStkDate').value;
      const div = Number(byId('addStkDiv').value || 0);

      if (!name || !shares || !buy) { alert('請填寫完整資訊'); return; }

      const item = { B: name, C: shares, D: buy, T: market, R: div, L: date, U: unit };

      const run = (window.google && google.script && google.script.run) ? google.script.run : null;
      if (!run) { alert('GAS 執行環境未就緒，請重試'); return; }

      toggleBusy(true);
      run
        .withSuccessHandler(() => {
          toggleBusy(false);
          closeDetail();
          fetchData();
        })
        .withFailureHandler(err => {
          toggleBusy(false);
          alert('新增失敗：' + (err && err.message || ''));
        })
        .addSTKItem(item);
    }
    function toggleAddBusy(on) {
      const ok = byId('stkAddOk');
      const txt = byId('stkAddOkTxt');
      const sp = byId('stkAddOkSpin');
      if (!ok) return;
      ok.disabled = !!on;
      if (txt && sp) {
        txt.style.display = on ? 'none' : 'inline';
        sp.style.display = on ? 'inline-block' : 'none';
      }
    }


    // ===== UI helpers =====
    function setupViewport() {
      vs.viewport = byId('stkViewport');
      vs.spacer = byId('stkSpacer');
      vs.thead = byId('stkHead');
      vs.tbody = byId('stkBody');
      if (!vs.viewport) return;
      let raf = null;
      vs.viewport.addEventListener('scroll', () => {
        if (raf) return;
        raf = requestAnimationFrame(() => { raf = null; renderVirtual(); });
      });
      // 點整列 -> 選擇該列
      vs.tbody?.addEventListener('click', (ev) => {
        const isInteractive = ev.target.closest('button, a, input, select, textarea');
        if (isInteractive) return;
        const tr = ev.target.closest('tr.stk-row');
        if (!tr) return;
        const rowId = Number(tr.dataset.row || 0);
        if (!rowId) return;
        selectRow(rowId);
      });
      // Mobile-friendly: pointerup 也可展開/收合（避開按鈕與輸入）
      vs.tbody?.addEventListener('pointerup', (ev) => {
        if (ev.pointerType && ev.pointerType !== 'touch' && ev.pointerType !== 'pen') return;
        const t = ev.target; if (!t) return;
        if (t.closest('button, .icon-btn, .cell-edit, a, input, select, textarea')) return;
        const tr = t.closest('tr.stk-row'); if (!tr) return;
        const rowId = Number(tr.dataset.row || 0); if (!rowId) return;
        if (st.expanded.has(rowId)) { st.expanded.delete(rowId); }
        else { st.expanded.clear(); st.expanded.add(rowId); }
        renderTable(viewRows);
      }, { passive: true });
      // iOS/部分瀏覽器：用 touchend 再補一次開合（避開互動元件）
      vs.tbody?.addEventListener('touchend', (ev) => {
        const t = ev.target; if (!t) return;
        if (t.closest('button, .icon-btn, .cell-edit, a, input, select, textarea')) return;
        const tr = t.closest('tr.stk-row'); if (!tr) return;
        const rowId = Number(tr.dataset.row || 0); if (!rowId) return;
        if (st.expanded.has(rowId)) { st.expanded.delete(rowId); }
        else { st.expanded.clear(); st.expanded.add(rowId); }
        renderTable(viewRows);
      }, { passive: true });
    }

    // ===== Generic helpers =====
    function byId(id) { return document.getElementById(id); }
    function esc(s) { return String(s ?? '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }
    function toNum(v) {
      if (v == null || v === '') return 0;
      if (typeof v === 'number') return isFinite(v) ? v : 0;
      const s = String(v).replace(/[%\uFFE5\u00A5$￥]/g, '').replace(/[\s,]/g, '');
      const x = parseFloat(s);
      return isFinite(x) ? x : 0;
    }
    function round(n, dec = 2) { const f = Math.pow(10, dec); return Math.round(n * f) / f; }
    function todayISO() { return new Date().toISOString().slice(0, 10); }
    function normalizePercent(u) {
      // 來源可能是：
      //  1) 分數：0.014 -> 1.4%
      //  2) 比率：1.5 -> 150%，5.5 -> 550%
      //  3) 直接百分數：55 -> 55%，550 -> 550%
      const n = Number(u || 0);
      if (!isFinite(n)) return null;
      const a = Math.abs(n);
      if (a === 0) return 0;
      if (a <= 1) return n * 100;  // 0.014 -> 1.4
      if (a < 10) return n * 100;  // 1.5 -> 150, 5.5 -> 550
      return n;                    // 55/550 -> 當作百分數
    }

    function fmtMoney(v) { return isFinite(+v) ? (+v).toLocaleString('zh-Hant-TW', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) : '—'; }
    function fmtMoneyN(v, n) { return isFinite(+v) ? (+v).toLocaleString('zh-Hant-TW', { minimumFractionDigits: n, maximumFractionDigits: n }) : '—'; }
    function fmtMoney2(v) { return fmtMoneyN(v, 2); }
    function fmtInt(v) { return isFinite(+v) ? Math.round(+v).toLocaleString('zh-Hant-TW') : '—'; }
    function isSoldRow(r) {
      const a = r && r.A;
      // 使用者指示：TRUE 應該是已結清，FALSE 才是持有中
      const s = String(a || '').trim().toUpperCase();
      if (s === 'TRUE' || s === '已賣出') return true; // TRUE = Sold
      return false; // FALSE or Empty = Holding
    }
    function fmtDate(v) {
      try {
        if (v instanceof Date) {
          return new Date(v.getTime() - v.getTimezoneOffset() * 60000).toISOString().slice(0, 10);
        }
        const s = String(v || '').trim();
        if (!s) return '';
        const d = new Date(s);
        return isNaN(d) ? s : d.toISOString().slice(0, 10);
      } catch (_) { return String(v || ''); }
    }
    function setNum(id, v, frac = 1) {
      const el = byId(id); if (!el) return;
      const n = Number(v);
      el.textContent = isFinite(n) ? n.toLocaleString('zh-Hant-TW', { minimumFractionDigits: frac, maximumFractionDigits: frac }) : '—';
      if (!el.classList.contains('mask-num')) el.classList.add('mask-num');
      if (!el.dataset.maskStr) el.dataset.maskStr = '＊＊＊';
    }
    function roiPillHTML(v) {
      if (v == null || !isFinite(+v)) return '<span class="monolith-label mask-num" data-mask-str="＊＊＊">---</span>';
      const n = Number(v);
      const cls = n > 0 ? 'monolith-gain' : (n < 0 ? 'monolith-loss' : '');
      const sign = n > 0 ? '▲' : (n < 0 ? '▼' : '');
      const s = Math.abs(n).toLocaleString('zh-Hant-TW', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
      return `<span class="monolith-label ${cls} mask-num" style="font-weight:700;" data-mask-str="＊＊＊">${sign} ${s}%</span>`;
    }
    function setRoiPill(el, v) { if (el) el.innerHTML = roiPillHTML(v); }
    function setBodyLoading(on) {
      const tb = byId('stkBody'); if (!tb) return;
      tb.innerHTML = on ? `<tr><td class="empty" colspan="${st.totalCols}">載入中…</td></tr>` : '';
    }
    function failUI(msg) {
      const tb = byId('stkBody'); if (tb) tb.innerHTML = `<tr><td class="empty" colspan="${st.totalCols}">發生錯誤：${esc(msg || '')}</td></tr>`;
    }
    function toggleBusy(on) {
      const ok = byId('stkEditOk');
      const txt = byId('stkEditOkTxt');
      const sp = byId('stkEditOkSpin');
      if (!ok) return;
      ok.disabled = !!on;
      if (txt && sp) {
        txt.style.display = on ? 'none' : 'inline';
        sp.style.display = on ? 'inline-block' : 'none';
      }
    }

    // === Market aggregation and renderer ===
    function computeByMarket(rows) {
      const by = new Map();
      rows.forEach(r => {
        const t = String(r.T || '').trim() || '-';
        const mv = toNum(r.N);
        const pl = toNum(r.G);
        const cost = toNum(r.K);
        const roiRow = normalizePercent(r.H);     // 跟 KPI 同步：先把 H 正規化成百分比
        const cur = by.get(t) || { T: t, MV: 0, PL: 0, Cost: 0, w: 0, wU: 0 };
        cur.MV += mv; cur.PL += pl; cur.Cost += cost;
        if (isFinite(roiRow) && mv) { cur.w += mv; cur.wU += (mv * roiRow); }
        by.set(t, cur);
      });
      return Array.from(by.values());
    }

    function renderMarketsCard() {
      const targets = [document.getElementById('stkMarketsList'), document.getElementById('investMarketsList')].filter(Boolean);
      if (!targets.length) return; // 沒有任何容器就跳過

      // 與主清單一致的過濾（持有/已賣出）
      let rows = allRows.slice();
      rows = st.showOnlyOpen ? rows.filter(r => !isSoldRow(r)) : rows.filter(r => isSoldRow(r));

      const items = computeByMarket(rows);
      const order = { US: 0, TW: 1, VN: 2, CTBC: 3 };
      items.sort((a, b) => (order[a.T] ?? 9) - (order[b.T] ?? 9));

      // 累計所有市場市值（依當前持有/已賣出篩選），供 dashmain 監聽使用
      const totalMarketsMV = items.reduce((s, o) => s + (Number(o.MV) || 0), 0);
      window.__stkMarketsMV__ = totalMarketsMV;
      try {
        window.dispatchEvent(new CustomEvent('stk:marketsMV', { detail: { mv: totalMarketsMV } }));
      } catch (_) { }

      // --- build two flavors: STK (with PL) & Dashboard (w/o PL) ---
      const htmlForSTK = items.map(o => {
        const roiPct = o.w ? (o.wU / o.w) : 0;
        const roiHTML = roiPillHTML(roiPct);
        const active = (String(st.market || '') === String(o.T));
        return `<div class="mkt-row${active ? ' active' : ''}" data-mkt="${esc(o.T)}">
        <div class="mkt-name">${esc(o.T || '-')}</div>
        <div class="mkt-mv mask-num" data-mask-str="＊＊＊">${fmtMoney(o.MV)}</div>
        <div class="sub">
          <div class="pl mask-num" data-mask-str="＊＊＊">${fmtMoney(o.PL)}</div>
          <div class="roi">${roiHTML}</div>
        </div>
      </div>`;
      }).join('');

      const htmlForDash = items.map(o => {
        const roiPct = o.w ? (o.wU / o.w) : 0;
        const roiHTML = roiPillHTML(roiPct);
        return `<div class="kpi-item" data-mkt="${esc(o.T)}">
        <div class="k">${esc(o.T || '-')}</div>
        <div class="v  .invest-layout {
    display: flex;
    gap: var(--space-lg);
    align-items: flex-start;
    margin-top: 0;
  }
gap:6px; white-space:nowrap;">
          <span class="money capsule mask-num" data-mask-str="＊＊＊">${fmtMoney(o.MV)}</span>
          ${roiHTML}
        </div>
      </div>`;
      }).join('');

      targets.forEach(box => {
        const isDash = (box.id === 'investMarketsList');
        box.innerHTML = (isDash ? htmlForDash : htmlForSTK) || (isDash ? '' : '<div class="empty">沒有資料</div>');
        const els = isDash ? box.querySelectorAll('.kpi-item[data-mkt]') : box.querySelectorAll('.mkt-row[data-mkt]');
        els.forEach(el => {
          el.onclick = () => {
            const m = el.getAttribute('data-mkt');
            st.market = m;
            st.selectedRow = null;
            closeDetail();
            applyFilter();
            renderKPI(viewRows);
            renderHead();
            renderTable(viewRows);
            renderMarketsCard();
            if (isDash && typeof go === 'function') go('invest');
          };
        });
      });
    }

    function selectRow(rowId) {
      st.selectedRow = rowId;
      renderVirtual();
      renderDetailCard(rowId);
    }

    function renderDetailCard(rowId) {
      const container = byId('investDetailCardContainer');
      if (!container) return;
      const r = allRows.find(x => Number(x.ROW) === rowId);
      if (!r) { container.innerHTML = ''; return; }

      const roi = normalizePercent(r.H);
      const isActive = !isSoldRow(r);

      container.innerHTML = `
        <div class="card stk-details-card damping-open" style="margin-top:20px;">
          <div class="card-hd">
            <span class="material-symbols-outlined">analytics</span>
            <strong>細節詳情：${esc(r.B || '-')}</strong>
            <button class="btn-ghost" onclick="App.modules.stk.closeDetail()" style="margin-left:auto;"><span class="material-symbols-outlined">close</span></button>
          </div>
          <div class="stk-detail-grid" style="display:grid; grid-template-columns: 1fr; gap:0px; padding:0px;">
            <div class="detail-info">
              <!-- Monolith Style Box (Integrated) -->
              <div class="monolith-card" style="background:var(--card); box-shadow:var(--neu-pressed); border:1px solid var(--hairline); color:var(--text); background-image:none; padding:24px; border-radius:20px;">
                  <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:24px;">
                      <div>
                          <div class="monolith-symbol" style="color:var(--text); font-size:32px; font-weight:900;">${esc(typeof r.B === 'string' ? r.B.split(' ')[0] : (r.B || 'STK'))}</div>
                          <div class="monolith-label">Terminal / Asset Profile</div>
                      </div>
                      <div style="text-align:right;">
                          <div class="monolith-price" style="font-size:36px; font-weight:900;">$${fmtMoney2(r.E)}</div>
                          <div style="margin-top:4px;">${roiPillHTML(roi)}</div>
                      </div>
                  </div>
                  
                  <!-- Integrated Info & Action Grid -->
                  <div style="display:grid; grid-template-columns: 1fr; gap:16px; padding-top:24px; border-top:1px solid color-mix(in oklab, var(--text) 5%, transparent);">
                      
                      <!-- Row 1: Position & Avg Cost -->
                      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                          <div class="mono-item">
                              <div class="monolith-label" style="margin-bottom:4px;">持股數量</div>
                              <div style="font-family:'JetBrains Mono'; font-weight:700; font-size:18px;">${fmtInt(r.C)}</div>
                          </div>
                          <div class="mono-item">
                              <div class="monolith-label" style="margin-bottom:4px;">平均成本</div>
                              <div style="font-family:'JetBrains Mono'; font-weight:700; font-size:18px;">$${fmtMoney2(r.F)}</div>
                          </div>
                      </div>

                      <!-- Row 2: Buy Price (Editable) -->
                      <div style="display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:end;">
                          <div class="mono-item">
                              <div class="monolith-label" style="margin-bottom:4px;">初始買價</div>
                              <input type="number" step="any" value="${toNum(r.D)}" id="detInputD" class="input" 
                                     style="background:rgba(0,0,0,0.03); border:none; font-family:'JetBrains Mono'; font-weight:700; font-size:16px; padding:8px 12px; border-radius:8px; width:100%;">
                          </div>
                          <button class="btn-mini" onclick="App.modules.stk.updateField(${rowId}, 'D', 'detInputD')" 
                                  style="height:38px; padding:0 15px; border-radius:8px; font-size:12px;">更新</button>
                      </div>

                      <!-- Row 3: Market Price (Editable) -->
                      <div style="display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:end;">
                          <div class="mono-item">
                              <div class="monolith-label" style="margin-bottom:4px;">目前現價</div>
                              <input type="number" step="any" value="${toNum(r.E)}" id="detInputE" class="input" 
                                     style="background:rgba(0,0,0,0.03); border:none; font-family:'JetBrains Mono'; font-weight:700; font-size:16px; padding:8px 12px; border-radius:8px; width:100%;">
                          </div>
                          <button class="btn-mini" onclick="App.modules.stk.updateField(${rowId}, 'E', 'detInputE')"
                                  style="height:38px; padding:0 15px; border-radius:8px; font-size:12px;">更新</button>
                      </div>

                      <!-- Row 4: Dividend (Editable) -->
                      <div style="display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:end;">
                          <div class="mono-item">
                              <div class="monolith-label" style="margin-bottom:4px;">累計股息</div>
                              <input type="number" step="any" value="${toNum(r.R)}" id="detInputR" class="input" 
                                     style="background:rgba(0,0,0,0.03); border:none; font-family:'JetBrains Mono'; font-weight:700; font-size:16px; padding:8px 12px; border-radius:8px; width:100%;">
                          </div>
                          <button class="btn-mini" onclick="App.modules.stk.updateField(${rowId}, 'R', 'detInputR')"
                                  style="height:38px; padding:0 15px; border-radius:8px; font-size:12px;">更新</button>
                      </div>

                      <!-- Row 5: Dates (Editable) -->
                      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                          <div class="mono-item">
                              <div class="monolith-label" style="margin-bottom:4px;">買入日期</div>
                              <div style="display:flex; gap:8px;">
                                <input type="date" value="${fmtDate(r.L)}" id="detInputL" class="input" 
                                       style="background:rgba(0,0,0,0.03); border:none; font-family:'JetBrains Mono'; font-weight:700; font-size:13px; padding:6px 8px; border-radius:8px; width:100%;">
                                <button class="btn-mini" onclick="App.modules.stk.updateValue(${rowId}, 'L', 'detInputL')" 
                                        style="height:32px; padding:0 8px; border-radius:6px; font-size:11px;">改</button>
                              </div>
                          </div>
                          <div class="mono-item">
                              <div class="monolith-label" style="margin-bottom:4px;">賣出日期</div>
                              <div style="display:flex; gap:8px;">
                                <input type="date" value="${fmtDate(r.M)}" id="detInputM" class="input" 
                                       style="background:rgba(0,0,0,0.03); border:none; font-family:'JetBrains Mono'; font-weight:700; font-size:13px; padding:6px 8px; border-radius:8px; width:100%;">
                                <button class="btn-mini" onclick="App.modules.stk.updateValue(${rowId}, 'M', 'detInputM')" 
                                        style="height:32px; padding:0 8px; border-radius:6px; font-size:11px;">改</button>
                              </div>
                          </div>
                      </div>

                      <!-- Row 6: Remarks -->
                      <div class="mono-item">
                          <div class="monolith-label" style="margin-bottom:4px;">備註說明</div>
                          <div style="font-size:13px; opacity:0.8; padding:8px 0;">${esc(r.AH || '-')}</div>
                      </div>

                      <!-- Row 6: Status Toggle -->
                      <div class="mono-item">
                          <div class="monolith-label" style="margin-bottom:8px;">資產狀態</div>
                          <div class="seg" style="display:flex; background:rgba(0,0,0,0.05); border-radius:10px; padding:3px; gap:4px;">
                              <button onclick="App.modules.stk.updateStatus(${rowId}, 'TRUE')" 
                                      style="flex:1; border:none; background:${isActive ? 'var(--card)' : 'transparent'}; color:${isActive ? 'var(--tint)' : 'var(--muted)'}; padding:8px; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer; box-shadow:${isActive ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'};">
                                  持有中
                              </button>
                              <button onclick="App.modules.stk.showSoldFlow(${rowId})" 
                                      style="flex:1; border:none; background:${!isActive ? 'var(--card)' : 'transparent'}; color:${!isActive ? 'var(--tint)' : 'var(--muted)'}; padding:8px; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer; box-shadow:${!isActive ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'};">
                                  已賣出
                              </button>
                          </div>
                      </div>
                  </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generateSparklineSVG(row) {
      const base = toNum(row.E);
      const points = 10;
      const data = Array.from({ length: points }, (_, i) => base * (0.95 + Math.random() * 0.1));
      const min = Math.min(...data);
      const max = Math.max(...data);
      const range = max - min || 1;

      const width = 100;
      const height = 36;
      const path = data.map((v, i) => {
        const x = (i / (points - 1)) * width;
        const y = height - ((v - min) / range) * height;
        return `${i === 0 ? 'M' : 'L'} ${x.toFixed(1)} ${y.toFixed(1)}`;
      }).join(' ');

      const color = (data[points - 1] >= data[0]) ? '#00ffa3' : '#ff2e5b';
      return `<svg class="sparkline" viewBox="0 0 ${width} ${height}" style="color:${color};"><path d="${path}" stroke="currentColor" fill="none" /></svg>`;
    }

    function closeDetail() {
      const card = document.querySelector('.stk-details-card');
      if (card) {
        card.classList.remove('damping-open');
        card.classList.add('damping-close');
        setTimeout(() => {
          st.selectedRow = null;
          renderVirtual();
          const container = byId('investDetailCardContainer');
          if (container) container.innerHTML = '';
        }, 400);
      } else {
        st.selectedRow = null;
        renderVirtual();
        const container = byId('investDetailCardContainer');
        if (container) container.innerHTML = '';
      }
    }

    function initKLineChart(row) {
      const canvas = byId('stkKLineCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      // 模擬一些數據，基於現價 (E)
      const base = toNum(row.E);
      const data = Array.from({ length: 12 }, (_, i) => base * (0.9 + Math.random() * 0.2));
      const labels = Array.from({ length: 12 }, (_, i) => (i + 1) + '月');

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '模擬股價',
            data: data,
            borderColor: 'var(--tint)',
            backgroundColor: 'rgba(75, 108, 183, 0.1)',
            borderWidth: 2,
            pointRadius: 0,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { enabled: true } },
          scales: {
            x: { display: false },
            y: { display: false }
          }
        }
      });
    }

    function updateField(rowId, col, inputId) {
      const val = toNum(byId(inputId)?.value);
      toggleBusy(true);
      google.script.run
        .withSuccessHandler(() => { toggleBusy(false); fetchData(); setTimeout(() => selectRow(rowId), 500); })
        .withFailureHandler(err => { toggleBusy(false); alert('更新失敗：' + (err && err.message || '')); })
        .setSTKValue(rowId, col, val, null);
    }

    function updateStatus(rowId, val) {
      if (val === '已賣出') {
        const sellDate = byId('detInputM')?.value;
        if (!sellDate) {
          alert('請先填寫「賣出日期」後再切換為已賣出狀態');
          // 強制重置選取狀態 (這裡簡單的做法是重新整理卡片)
          renderDetailCard(rowId);
          return;
        }
      }
      toggleBusy(true);
      google.script.run
        .withSuccessHandler(() => { toggleBusy(false); fetchData(); setTimeout(() => selectRow(rowId), 500); })
        .withFailureHandler(err => { toggleBusy(false); alert('更新失敗：' + (err && err.message || '')); })
        .setSTKValue(rowId, 'A', val, null);
    }

    function updateValue(rowId, col, inputId) {
      const val = byId(inputId)?.value;
      if (!val && col === 'M') { /* allow empty sell date */ }
      toggleBusy(true);
      google.script.run
        .withSuccessHandler(() => { toggleBusy(false); fetchData(); setTimeout(() => selectRow(rowId), 500); })
        .withFailureHandler(err => { toggleBusy(false); alert('更新失敗：' + (err && err.message || '')); })
        .setSTKValue(rowId, col, val, null);
    }

    function showSoldFlow(rowId) {
      // Re-use existing edit logic for split sell or implementation of new flow
      onEditCellClick({ currentTarget: { dataset: { col: 'A' }, closest: () => ({ dataset: { row: rowId } }) } });
    }

    return { init, renderMarketsCard, closeDetail, updateField, updateStatus, updateValue, showSoldFlow, generateSparklineSVG, renderAddStockCard, submitAdd };
  })();

  ; (function autoInitSTK() {
    try {
      const start = () => { if (App && App.modules && App.modules.stk && typeof App.modules.stk.init === 'function') App.modules.stk.init(); };
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start);
      else start();
    } catch (_) { }
  })();
</script>