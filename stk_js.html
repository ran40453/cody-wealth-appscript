<!-- stk_js.html -->
<script>
window.App = window.App || {};
App.modules = App.modules || {};

App.modules.stk = (function(){
  // ===== Config（之後要擴充可編輯欄位就在這裡加）=====
  const EDITABLE_FIELDS = {
    E: { key:'E', label:'現價', type:'number', decimals:3, min:0, updateDateCol:'S' },
    R: { key:'R', label:'股息', type:'number', decimals:2, min:0, updateDateCol:'S' }
    // 範例：之後想開 K(成本)、Q(手續+稅)… 只要加：
    // ,K:{ key:'K', label:'成本', type:'number', decimals:1, min:0, updateDateCol:'S' }
  };

  // ===== State =====
  let allRows = [];
  let viewRows = [];
  const vs = { rowH:44, viewport:null, spacer:null, thead:null, tbody:null, last:[-1,-1] };

  // ===== Init =====
  function init(){
    setupViewport();
    bindKPIFold();
    bindGlobalEditModal();
    setBodyLoading(true);
    fetchData();
  }

  // ===== Data =====
  function fetchData(){
    if (!(window.google && google.script && google.script.run)) {
      if (!fetchData._try) fetchData._try = 0;
      if (fetchData._try++ < 40) { setTimeout(fetchData, 250); return; }
      failUI('載入失敗：Apps Script 未就緒');
      return;
    }
    google.script.run
      .withSuccessHandler(rows=>{
        allRows = Array.isArray(rows) ? rows : [];
        viewRows = allRows.slice();
        renderKPI(viewRows);
        renderHead();
        renderTable(viewRows);
      })
      .withFailureHandler(err=> failUI(err && err.message || '讀取失敗'))
      .getSTKRows();
  }

  // ===== KPI =====
  function renderKPI(rows){
    const sum = k => rows.reduce((s,r)=> s + toNum(r[k]), 0);
    const totalMV   = sum('N'); // 市場價值
    const totalCost = sum('K'); // 成本
    const totalUPL  = sum('J'); // 未實現損益
    const totalPL   = sum('G'); // 損益(NT)

    // 加權 ROI（用 N 權重）
    let w=0, wU=0;
    rows.forEach(r=>{
      const n = toNum(r.N);
      const u = normalizePercent(r.H);
      if (n) { w += n; wU += (n * u); }
    });
    const roi = w ? (wU / w) : null;

    setNum('stkKpiMV',   totalMV,   1);
    setNum('stkKpiCost', totalCost, 1);
    setNum('stkKpiUPL',  totalUPL,  1);
    setNum('stkKpiPL',   totalPL,   1);
    setRoiPill(byId('stkKpiROI'), roi);
  }

  // ===== Head =====
  function renderHead(){
    if (!vs.thead) return;
    vs.thead.innerHTML = `<tr>
      <th class="txt">產品</th>               <!-- B -->
      <th class="num col-fix-1">股數</th>     <!-- C -->
      <th class="num col-fix-2">均價</th>     <!-- F -->
      <th class="num col-fix-3">現價</th>     <!-- E (editable) -->
      <th class="num col-fix-4">市場價值</th> <!-- N -->
      <th class="num">成本</th>               <!-- K -->
      <th class="txt">未實現損益 / ROI</th>  <!-- J + H -->
      <th class="num">股息</th>               <!-- R (editable) -->
      <th class="num">手續+稅</th>           <!-- Q -->
      <th class="txt">市場</th>               <!-- T -->
      <th class="txt">單位</th>               <!-- U -->
      <th class="txt">買日</th>               <!-- L -->
      <th class="txt">賣日</th>               <!-- M -->
      <th class="txt">狀態</th>               <!-- A -->
      <th class="txt">更新日</th>             <!-- S -->
    </tr>`;
  }

  // ===== Body (virtual list) =====
  function renderTable(rows){
    if (vs.spacer) vs.spacer.style.height = (rows.length * vs.rowH) + 'px';
    if (vs.tbody)  { vs.tbody.style.transform = 'translateY(0px)'; vs.tbody.innerHTML=''; }
    vs.last = [-1,-1];
    renderVirtual();
  }
  function renderVirtual(){
    if (!vs.viewport || !vs.tbody) return;
    const top  = vs.viewport.scrollTop;
    const h    = vs.viewport.clientHeight;
    const start= Math.max(0, Math.floor(top / vs.rowH) - 10);
    const need = Math.ceil(h / vs.rowH) + 20;
    const end  = Math.min(viewRows.length, start + need);
    if (vs.last[0]===start && vs.last[1]===end) return;
    vs.last = [start, end];

    const slice = viewRows.slice(start, end);
    vs.tbody.style.transform = `translateY(${start * vs.rowH}px)`;
    vs.tbody.innerHTML = slice.map(r=>{
      const roi = normalizePercent(r.H);
      const mv  = fmtMoney(r.N);
      const cost= fmtMoney(r.K);
      const upl = fmtMoney(r.J);

      return `<tr data-row="${Number(r.ROW||0)}">
        <td class="txt">${esc(r.B||'-')}</td>
        <td class="num col-fix-1">${fmtInt(r.C)}</td>
        <td class="num col-fix-2">${fmtMoney(r.F)}</td>

        <td class="num col-fix-3">
          <button class="cell-edit" data-col="E" title="點擊編輯現價">${fmtMoney(r.E)}</button>
        </td>

        <td class="num col-fix-4">${mv}</td>
        <td class="num">${cost}</td>
        <td class="txt">
          <div class="pnl-cell">
            <span class="num">${upl}</span>
            ${roiPillHTML(roi)}
          </div>
        </td>

        <td class="num">
          <button class="cell-edit" data-col="R" title="點擊編輯股息">${fmtMoney(r.R)}</button>
        </td>

        <td class="num">${fmtMoney(r.Q)}</td>
        <td class="txt">${esc(r.T||'')}</td>
        <td class="txt">${esc(r.U||'')}</td>
        <td class="txt">${fmtDate(r.L)}</td>
        <td class="txt">${fmtDate(r.M)}</td>
        <td class="txt">${String(r.A||'').trim()? '已賣出':'—'}</td>
        <td class="txt">${fmtDate(r.S)}</td>
      </tr>`;
    }).join('');

    // 綁定本頁 slice 的編輯事件（事件代理）
    vs.tbody.querySelectorAll('.cell-edit').forEach(btn=>{
      btn.addEventListener('click', onEditCellClick);
    });

    if (!slice.length){
      vs.tbody.style.transform = 'translateY(0px)';
      vs.tbody.innerHTML = `<tr><td class="empty" colspan="15">目前沒有資料</td></tr>`;
    }
  }

  // ===== Edit modal =====
  function bindGlobalEditModal(){
    const dlg = byId('stkEditDlg');
    const form= byId('stkEditForm');
    const input= byId('stkEditInput');
    const ok  = byId('stkEditOk');
    const cancel = byId('stkEditCancel');

    if (!dlg || !form) return;

    cancel.onclick = () => closeEdit();
    ok.onclick = (e)=>{ e.preventDefault(); submitEdit(); };
    form.onsubmit = (e)=>{ e.preventDefault(); submitEdit(); };
    input.onkeydown = (e)=>{ if (e.key === 'Escape') closeEdit(); };
  }

  function onEditCellClick(e){
    const btn = e.currentTarget;
    const tr  = btn.closest('tr');
    const row = Number(tr && tr.dataset.row || 0);
    const col = String(btn.dataset.col||'').toUpperCase();

    const field = EDITABLE_FIELDS[col];
    if (!row || !field) return;

    const r = allRows.find(x => Number(x.ROW)===row);
    const current = r ? r[col] : '';

    openEdit({
      row, col,
      title: field.label,
      type: field.type,
      value: toNum(current),
      decimals: field.decimals ?? 2,
      min: field.min ?? null,
      updateDateCol: field.updateDateCol || null
    });
  }

  function openEdit(meta){
    const dlg = byId('stkEditDlg');
    if (!dlg) return;
    dlg.dataset.row = meta.row;
    dlg.dataset.col = meta.col;
    dlg.dataset.decimals = meta.decimals;
    dlg.dataset.min = (meta.min==null ? '' : String(meta.min));
    dlg.dataset.updateDateCol = meta.updateDateCol || '';
    byId('stkEditTitle').textContent = `編輯：${meta.title}`;
    const input = byId('stkEditInput');
    input.type = (meta.type==='number' ? 'number' : 'text');
    input.step = (meta.type==='number' ? 'any' : undefined);
    input.value = (meta.value ?? '');
    dlg.style.display = 'block';
    setTimeout(()=> input.focus(), 0);
  }
  function closeEdit(){
    const dlg = byId('stkEditDlg');
    if (!dlg) return;
    dlg.style.display = 'none';
    dlg.dataset.row = dlg.dataset.col = dlg.dataset.decimals = dlg.dataset.min = dlg.dataset.updateDateCol = '';
  }

  function submitEdit(){
    const dlg = byId('stkEditDlg');
    if (!dlg) return;
    const row = Number(dlg.dataset.row||0);
    const col = String(dlg.dataset.col||'');
    const decimals = Number(dlg.dataset.decimals||2);
    const min = (dlg.dataset.min===''? null : Number(dlg.dataset.min));
    const updateDateCol = dlg.dataset.updateDateCol || '';
    const input = byId('stkEditInput');
    let val = input.value;

    if (val==='' || val==null){
      alert('請輸入數值');
      return;
    }
    let num = toNum(val);
    if (min!=null && num < min){
      alert(`數值不可小於 ${min}`);
      return;
    }

    // 後端 API：setSTKValue(row, col, value, updateDateCol)
    toggleBusy(true);
    google.script.run
      .withSuccessHandler(ok=>{
        toggleBusy(false);
        closeEdit();
        // 更新前端快取
        const r = allRows.find(x=> Number(x.ROW)===row);
        if (r){ r[col] = round(num, decimals); if (updateDateCol) r[updateDateCol] = todayISO(); }
        // 重新算 KPI & 局部重繪：這裡偷懶直接重繪虛擬片段
        renderKPI(viewRows);
        renderVirtual();
      })
      .withFailureHandler(err=>{
        toggleBusy(false);
        alert('寫入失敗：' + (err && err.message || ''));
      })
      .setSTKValue(row, col, round(num, decimals), updateDateCol || null);
  }

  // ===== UI helpers =====
  function setupViewport(){
    vs.viewport = byId('stkViewport');
    vs.spacer   = byId('stkSpacer');
    vs.thead    = byId('stkHead');
    vs.tbody    = byId('stkBody');
    if (!vs.viewport) return;
    let raf=null;
    vs.viewport.addEventListener('scroll', ()=>{
      if (raf) return;
      raf = requestAnimationFrame(()=>{ raf=null; renderVirtual(); });
    });
  }
  function bindKPIFold(){
    const btn = byId('stkKpiToggle');
    const wrap= byId('stkKPI');
    if (btn && wrap){
      btn.onclick = ()=>{
        const on = wrap.dataset.collapsed === '1' ? '0' : '1';
        wrap.dataset.collapsed = on;
        btn.textContent = (on==='1') ? '展開統計' : '收合統計';
      };
    }
  }

  // ===== Generic helpers =====
  function byId(id){ return document.getElementById(id); }
  function esc(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m])); }
  function toNum(v){
    if (v == null || v === '') return 0;
    if (typeof v === 'number') return isFinite(v) ? v : 0;
    const s = String(v).replace(/[%\uFFE5\u00A5$￥]/g,'').replace(/[\s,]/g,'');
    const x = parseFloat(s);
    return isFinite(x) ? x : 0;
  }
  function round(n, dec=2){ const f = Math.pow(10, dec); return Math.round(n * f) / f; }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function normalizePercent(u){
    const n = Number(u||0);
    if (!isFinite(n)) return null;
    return (Math.abs(n) <= 1) ? (n*100) : n; // 0.12 => 12%
  }
  function fmtMoney(v){ return isFinite(+v) ? (+v).toLocaleString('zh-Hant-TW',{minimumFractionDigits:1, maximumFractionDigits:1}) : '—'; }
  function fmtInt(v){ return isFinite(+v) ? Math.round(+v).toLocaleString('zh-Hant-TW') : '—'; }
  function fmtDate(v){
    try{
      if (v instanceof Date) {
        return new Date(v.getTime() - v.getTimezoneOffset()*60000).toISOString().slice(0,10);
      }
      const s = String(v||'').trim();
      if (!s) return '';
      const d = new Date(s);
      return isNaN(d) ? s : d.toISOString().slice(0,10);
    }catch(_){ return String(v||''); }
  }
  function setNum(id, v, frac=1){
    const el = byId(id); if (!el) return;
    const n = Number(v);
    el.textContent = isFinite(n) ? n.toLocaleString('zh-Hant-TW',{minimumFractionDigits:frac, maximumFractionDigits:frac}) : '—';
    if (!el.classList.contains('mask-num')) el.classList.add('mask-num');
    if (!el.dataset.maskStr) el.dataset.maskStr = '＊＊＊';
  }
  function roiPillHTML(v){
    if (v == null || !isFinite(+v)) return '<span class="roi-badge zero">—</span>';
    const n = Number(v);
    const cls  = n>0 ? 'pos' : (n<0 ? 'neg' : 'zero');
    const sign = n>0 ? '+' : (n<0 ? '−' : '');
    const s = Math.abs(n).toLocaleString('zh-Hant-TW',{minimumFractionDigits:1, maximumFractionDigits:1});
    return `<span class="roi-badge ${cls}">${sign}${s}%</span>`;
  }
  function setRoiPill(el, v){ if (el) el.innerHTML = roiPillHTML(v); }
  function setBodyLoading(on){
    const tb = byId('stkBody'); if (!tb) return;
    tb.innerHTML = on ? `<tr><td class="empty" colspan="15">載入中…</td></tr>` : '';
  }
  function failUI(msg){
    const tb = byId('stkBody'); if (tb) tb.innerHTML = `<tr><td class="empty" colspan="15">發生錯誤：${esc(msg||'')}</td></tr>`;
  }
  function toggleBusy(on){
    const ok = byId('stkEditOk');
    const txt= byId('stkEditOkTxt');
    const sp = byId('stkEditOkSpin');
    if (!ok) return;
    ok.disabled = !!on;
    if (txt && sp){
      txt.style.display = on ? 'none' : 'inline';
      sp.style.display  = on ? 'inline-block' : 'none';
    }
  }

  return { init };
})();
</script>