<script>
  // EXPLICIT GLOBAL SCOPE - NO IIFE FOR DEBUGGING
  console.log('[DBV2] Global Script Load Start');

  window.App = window.App || {};
  window.App.pages = window.App.pages || {};
  window.App.routes = window.App.routes || {};

  var DBV2_STATE = { fx: 32 };

  function db2_numOr() {
    for (var i = 0; i < arguments.length; i++) {
      var n = Number(arguments[i]);
      if (isFinite(n)) return n;
    }
    return 0;
  }

  function db2_fmt(n, frac) {
    var num = Number(n);
    return isFinite(num) ? num.toLocaleString('zh-Hant-TW', { minimumFractionDigits: frac || 0, maximumFractionDigits: frac || 0 }) : '—';
  }

  function db2_setText(id, v, frac, prefix) {
    var el = document.getElementById(id);
    if (!el) return;
    var n = Number(v);
    var str = isFinite(n) ? db2_fmt(n, frac) : '—';
    el.textContent = (prefix || '') + str;
    el.classList.add('mask-num');
    el.dataset.maskStr = '＊＊＊';
  }

  function db2_esc(s) {
    return String(s || '').replace(/[&<>"']/g, function (m) {
      return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
    });
  }

  function db2_roiChipHTML(v) {
    if (v == null || !isFinite(+v)) return '<span class="db-v2-pill neu-inset-v2" style="opacity:0.3;">---</span>';
    var n = Number(v);
    var cls = n >= 0 ? 'pos' : 'neg';
    var sign = n >= 0 ? '▲' : '▼';
    return '<div class="db-v2-pill ' + cls + '">' +
      '<span class="material-symbols-outlined" style="font-size:10px;">' + (n >= 0 ? 'trending_up' : 'trending_down') + '</span>' +
      '<span>' + sign + ' ' + Math.abs(n).toFixed(1) + '%</span>' +
      '</div>';
  }

  function db2_renderDashboard(data) {
    if (!data) return;
    console.log('[DBV2] Rendering KPIs');
    var k = data.kpis || {};
    var latest = (data.database && data.database.latest) || {};

    db2_setText('db2TotalAssets', db2_numOr(k.total));
    db2_setText('db2NetAssets', db2_numOr(k.net), 0, '$');
    db2_setText('db2Cash', db2_numOr(k.cash), 0, '$');
    db2_setText('db2Avail', db2_numOr(k.avail), 0, '$');
    db2_setText('db2USD', db2_numOr(k.usd, latest.CU), 0, '$');

    var dEl = document.getElementById('db2LastUpdate');
    if (dEl) dEl.textContent = k.date || '—';

    var pill = document.getElementById('db2PnLPill');
    var perc = document.getElementById('db2PnLPerc');
    var dayPnl = db2_numOr(latest.F, k.dayPnl);
    if (pill && perc) {
      pill.classList.remove('pos', 'neg');
      pill.classList.add(dayPnl >= 0 ? 'pos' : 'neg');
      perc.textContent = (dayPnl >= 0 ? '+' : '') + db2_fmt(dayPnl, 0);
    }
  }

  function db2_renderFunds(fundData) {
    if (!fundData) return;
    console.log('[DBV2] Rendering Funds');
    var fx = DBV2_STATE.fx;
    var totalN = (db2_numOr(fundData.ctbcUSD_N) * fx) + db2_numOr(fundData.ctbcTWD_N);
    var totalAF = (db2_numOr(fundData.ctbcUSD_AF) * fx) + db2_numOr(fundData.ctbcTWD_AF);

    db2_setText('db2FundVal', totalN, 0, '$');
    db2_setText('db2FundInt', totalAF, 0, '$');

    var totalT = (db2_numOr(fundData.ctbcUSD_T) * fx) + db2_numOr(fundData.ctbcTWD_T);
    var cost = totalN - totalT;
    var roi = cost > 0 ? (totalT / cost * 100) : 0;

    var roiEl = document.getElementById('db2FundROI');
    if (roiEl) roiEl.innerHTML = db2_roiChipHTML(roi);
  }

  function db2_renderStockList() {
    var wrap = document.getElementById('db2StockList');
    if (!wrap) return;
    console.log('[DBV2] Rendering Stocks');
    var stocks = window.__stkHoldings__ || [];
    // Filter holding only
    var holdings = stocks.filter(function (r) {
      var s = String(r.A || '').trim().toUpperCase();
      return s !== 'TRUE' && s !== '已賣出';
    });

    if (!holdings.length) {
      wrap.innerHTML = '<div style="font-size:10px; opacity:0.3; padding:10px; text-align:center;">No active holdings</div>';
      return;
    }
    wrap.innerHTML = holdings.slice(0, 3).map(function (s) {
      var val = db2_numOr(s.N);
      var roi = db2_numOr(s.H); // Adjusted mapping
      return '<div class="neu-inset-v2" style="display:flex; align-items:center; justify-content:space-between; padding:10px 16px; border-radius:16px;">' +
        '<div style="display:flex; align-items:center; gap:10px;">' +
        '<div style="width:32px; height:32px; border-radius:10px; background:rgba(0,0,0,0.05); display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:900;">' + db2_esc(String(s.B || '').substring(0, 2)) + '</div>' +
        '<div>' +
        '<div style="font-size:12px; font-weight:700;">' + db2_esc(s.B) + '</div>' +
        '<div style="font-size:9px; opacity:0.4;">EQUITY • ' + db2_esc(s.T) + '</div>' +
        '</div>' +
        '</div>' +
        '<div style="text-align:right;">' +
        '<div style="font-size:12px; font-weight:800;">$' + db2_fmt(val) + '</div>' +
        db2_roiChipHTML(roi) +
        '</div>' +
        '</div>';
    }).join('');
  }

  function db2_renderActivityList(summary) {
    var wrap = document.getElementById('db2ActivityList');
    if (!wrap) return;
    console.log('[DBV2] Rendering Activity');
    var loan = (summary && Array.isArray(summary.loan)) ? summary.loan : [];
    var normal = (summary && Array.isArray(summary.normal)) ? summary.normal : [];
    var normalTotal = db2_numOr(summary ? summary.normalTotalSum : 0) || normal.reduce(function (s, r) { return s + db2_numOr(r.sum); }, 0);

    db2_setText('db2ProjectedSum', normalTotal, 0, '$');

    var all = loan.concat(normal).slice(0, 4);
    wrap.innerHTML = all.map(function (r) {
      var s = db2_numOr(r.sum);
      var p = db2_numOr(r.posted);
      return '<div class="db-v2-item neu-inset-v2" style="padding:12px 16px;">' +
        '<div style="display:flex; align-items:center; gap:12px;">' +
        '<div class="neu-flat-v2 db-v2-icon-box" style="color:var(--tint);">' +
        '<span class="material-symbols-outlined" style="font-size:18px;">' + (s < 0 ? 'payments' : 'account_balance') + '</span>' +
        '</div>' +
        '<div>' +
        '<div style="font-size:13px; font-weight:700;">' + db2_esc(r.account) + '</div>' +
        '<div style="font-size:9px; opacity:0.4; text-transform:uppercase;">' + (p < 0 ? 'Liability' : 'Asset') + '</div>' +
        '</div>' +
        '</div>' +
        '<div style="display:flex; gap:8px;">' +
        '<div class="db-v2-cash-box posted"><span>POSTED</span>$' + db2_fmt(p) + '</div>' +
        '<div class="db-v2-cash-box projected"><span>SUM</span>$' + db2_fmt(s) + '</div>' +
        '</div>' +
        '</div>';
    }).join('');
  }

  function db2_renderWalletGrid(rows) {
    var wrap = document.getElementById('db2WalletGrid');
    if (!wrap) return;
    console.log('[DBV2] Rendering Wallet');
    var rest = (rows || []).filter(function (r) { return !String(r.account).includes('中信'); });
    db2_setText('db2WalletTotal', rest.reduce(function (s, r) { return s + db2_numOr(r.now); }, 0), 0, 'Total: $');

    wrap.innerHTML = rest.map(function (r) {
      return '<div class="neu-inset-v2" style="padding:16px; border-radius:24px; border-left:4px solid var(--tint);">' +
        '<div style="display:flex; justify-content:space-between; margin-bottom:12px;">' +
        '<div class="neu-flat-v2" style="width:32px; height:32px; border-radius:10px; display:flex; align-items:center; justify-content:center; opacity:0.6;">' +
        '<span class="material-symbols-outlined" style="font-size:18px;">account_balance</span>' +
        '</div>' +
        '<div style="font-size:9px; font-weight:800; opacity:0.3; text-transform:uppercase;">Active</div>' +
        '</div>' +
        '<div style="font-size:11px; font-weight:700; opacity:0.6; margin-bottom:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">' + db2_esc(r.account) + '</div>' +
        '<div style="font-size:18px; font-weight:900;" class="mask-num" data-mask-str="＊＊＊">$' + db2_fmt(r.now) + '</div>' +
        '</div>';
    }).join('');
  }

  function db2_fetchData() {
    console.log('[DBV2] fetchData starting');
    if (!window.google || !google.script || !google.script.run) return;
    var run = google.script.run.withFailureHandler(function (err) {
      console.error('[DBV2] Server Error:', err);
    });

    run.withSuccessHandler(function (res) { db2_renderDashboard(res); }).getDashboardData();
    run.withSuccessHandler(function (fx) {
      DBV2_STATE.fx = Number(fx) || 32;
      run.withSuccessHandler(function (funds) { db2_renderFunds(funds); }).getCTBCAggregates('fund');
    }).getUSDTWD();
    run.withSuccessHandler(function (summary) { db2_renderActivityList(summary); }).getDashBalanceSummary();
    run.withSuccessHandler(function (rows) { db2_renderWalletGrid(rows); }).getSummaryNow();
    db2_renderStockList();
  }

  function db2_init() {
    console.log('[DBV2] init() called');
    db2_fetchData();
  }

  // REGISTER TO GLOBAL App
  window.App.pages.db = {
    init: db2_init,
    refresh: db2_fetchData
  };

  window.App.routes.db = function () {
    console.log('[DBV2] Route db triggered');
    db2_init();
  };

  window.addEventListener('stk:marketsMV', function () { db2_renderStockList(); });

  // Immediate trigger check
  if (window.App.currentPage === 'db') {
    db2_init();
  }
</script>